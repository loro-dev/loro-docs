import styles from './api-reference.module.css'
import Indent from './indent';
import Method from './method';

<div className={styles.apiReference}>

# API Reference

## Overview

Loro is a powerful Conflict-free Replicated Data Type (CRDT) library that enables real-time collaboration. This API reference provides comprehensive documentation for all classes, methods, and types available in the JavaScript/TypeScript binding.

## Quick Navigation

- [**LoroDoc**](#lorodoc) - The main document class for managing CRDT state
- [**Container Types**](#container-types) - Data structures (Text, List, Map, Tree, Counter, MovableList)
- [**Synchronization**](#synchronization) - Import/export and real-time sync
- [**Version Control**](#version-control) - Time travel, checkouts, and forks
- [**Events & Subscriptions**](#events--subscriptions) - Change tracking and reactivity
- [**Undo/Redo**](#undoredo) - Local undo management
- [**Types & Interfaces**](#types--interfaces) - TypeScript type definitions

## Basic Usage

```typescript twoslash
import { LoroDoc } from "loro-crdt";

const doc = new LoroDoc();
const text = doc.getText("text");
text.insert(0, "Hello World");

// Subscribe to changes
const unsubscribe = doc.subscribe((event) => {
  console.log("Document changed:", event);
});

// Export updates for synchronization
const updates = doc.export({ mode: "update" });
```

---

## LoroDoc

The `LoroDoc` class is the central document that manages all CRDT containers and provides synchronization capabilities.

### Constructor

```typescript
new LoroDoc()
```

Creates a new Loro document with a randomly generated peer ID.

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
// ---cut---
const doc = new LoroDoc();
```

### Configuration Methods

<Method>
```typescript
setPeerId(peer: number | bigint | `${number}`): void
```
</Method>
<Indent>
Sets the peer ID for this document. It must be a number, a BigInt, or a decimal string that fits into an unsigned 64-bit integer.

**Parameters:**
- `peer` - Peer ID as number, bigint, or decimal string

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.setPeerId("42");
```
</Indent>

<Method>
```typescript
setRecordTimestamp(auto_record: boolean): void
```
</Method>
<Indent>
Configures whether to automatically record timestamps for changes. Timestamps use Unix time (seconds since epoch).

**Parameters:**
- `auto_record` - Whether to automatically record timestamps

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.setRecordTimestamp(true);
```
</Indent>

<Method>
```typescript
setChangeMergeInterval(interval: number): void
```
</Method>
<Indent>
Sets the interval in seconds for merging continuous local changes into a single change record.

**Parameters:**
- `interval` - Merge interval in seconds

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.setChangeMergeInterval(1000); // Merge changes within 1 second
```
</Indent>

<Method>
```typescript
configTextStyle(styles: StyleConfig): void
```
</Method>
<Indent>
Configures the behavior of text styles (marks) in rich text containers.

**Parameters:**
- `styles` - Configuration object mapping style names to their config

**StyleConfig Type:**
```typescript
type StyleConfig = Record<string, {
  expand?: "after" | "before" | "both" | "none"
}>
```

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.configTextStyle({
  bold: { expand: "after" },
  italic: { expand: "none" },
  link: { expand: "none" }
});
```
</Indent>

### Container Access Methods

<Method>
```typescript
getText(name: string): LoroText
```
</Method>
<Indent>
Gets or creates a text container with the given name.

**Parameters:**
- `name` - The container name

**Returns:** A `LoroText` instance

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const text = doc.getText("content");
text.insert(0, "Hello");
```
</Indent>

<Method>
```typescript
getList(name: string): LoroList
```
</Method>
<Indent>
Gets or creates a list container with the given name.

**Parameters:**
- `name` - The container name  

**Returns:** A `LoroList` instance

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const list = doc.getList("items");
list.push("Item 1");
```
</Indent>

<Method>
```typescript
getMap(name: string): LoroMap
```
</Method>
<Indent>
Gets or creates a map container with the given name.

**Parameters:**
- `name` - The container name

**Returns:** A `LoroMap` instance

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const map = doc.getMap("settings");
map.set("theme", "dark");
```
</Indent>

<Method>
```typescript
getTree(name: string): LoroTree
```
</Method>
<Indent>
Gets or creates a tree container with the given name.

**Parameters:**
- `name` - The container name

**Returns:** A `LoroTree` instance

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const tree = doc.getTree("fileSystem");
const root = tree.createNode();
```
</Indent>

<Method>
```typescript
getCounter(name: string): LoroCounter
```
</Method>
<Indent>
Gets or creates a counter container with the given name.

**Parameters:**
- `name` - The container name

**Returns:** A `LoroCounter` instance

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const counter = doc.getCounter("likes");
counter.increment(1);
```
</Indent>

<Method>
```typescript
getMovableList(name: string): LoroMovableList
```
</Method>
<Indent>
Gets or creates a movable list container with the given name.

**Parameters:**
- `name` - The container name

**Returns:** A `LoroMovableList` instance

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const movableList = doc.getMovableList("tasks");
movableList.push("Task 1");
movableList.move(0, 2); // Move first item to third position
```
</Indent>

<Method>
```typescript
getContainerById(id: ContainerID): Container | undefined
```
</Method>
<Indent>
Gets a container by its unique ID.

**Parameters:**
- `id` - The container ID

**Returns:** The container instance or undefined if not found

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const text = doc.getText("text");
const textId = text.id;
const sameText = doc.getContainerById(textId);
```
</Indent>

### Import/Export Methods

<Method>
```typescript
export(mode?: ExportMode): Uint8Array
```
</Method>
<Indent>
Exports the document in various formats for synchronization or persistence.

**Parameters:**
- `mode` - Export configuration (optional)

**ExportMode Options:**
```typescript
type ExportMode = 
  | { mode: "snapshot" }
  | { mode: "update", from?: VersionVector }
  | { mode: "shallow-snapshot", frontiers: Frontiers }
  | { mode: "updates-in-range", spans: { id: OpId; len: number }[] }
```

**Returns:** Encoded binary data

**Examples:**
```ts twoslash
import { LoroDoc, VersionVector } from "loro-crdt";
const doc = new LoroDoc();
declare const lastSyncVersion: VersionVector;
// ---cut---
// Export full snapshot
const snapshot = doc.export({ mode: "snapshot" });

// Export updates from a specific version
const updates = doc.export({ 
  mode: "update", 
  from: lastSyncVersion 
});

// Export shallow snapshot at current version
const shallowSnapshot = doc.export({ 
  mode: "shallow-snapshot",
  frontiers: doc.frontiers()
});
```
</Indent>

<Method>
```typescript
import(data: Uint8Array): ImportStatus
```
</Method>
<Indent>
Imports updates or snapshots into the document. Returns an `ImportStatus` describing which peer ranges were applied or are pending.

**Parameters:**
- `data` - Binary data or another LoroDoc to import from

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
declare const updates: Uint8Array;
// ---cut---
// Import binary updates
const status = doc.import(updates);
console.log(status.success);
```
</Indent>

<Method>
```typescript
importBatch(data: Uint8Array[]): ImportStatus
```
</Method>
<Indent>
Efficiently imports multiple updates in a single batch operation.

**Parameters:**
- `data` - Array of binary updates

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
declare const update1: Uint8Array;
declare const update2: Uint8Array;
declare const update3: Uint8Array;
// ---cut---
const updates = [update1, update2, update3];
const status = doc.importBatch(updates);
```
</Indent>

<Method>
```typescript
exportJsonUpdates(start?: VersionVector, end?: VersionVector, withPeerCompression?: boolean): JsonSchema
```
</Method>
<Indent>
Exports updates in JSON format for debugging or alternative storage.

**Parameters:**
- `start` - Starting version (optional)
- `end` - Ending version (optional)

**Returns:** JSON representation of updates

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const jsonUpdates = doc.exportJsonUpdates();
console.log(JSON.stringify(jsonUpdates, null, 2));
```
</Indent>

<Method>
```typescript
importJsonUpdates(json: string | JsonSchema): void
```
</Method>
<Indent>
Imports updates from JSON format.

**Parameters:**
- `json` - JSON string or object containing updates

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const jsonStr = '{"ops": [], "peer": "1"}';
doc.importJsonUpdates(jsonStr);
```
</Indent>

### Version Control Methods

<Method>
```typescript
checkout(frontiers: Frontiers): void
```
</Method>
<Indent>
Checks out the document to a specific version, making it read-only at that point in history.

**Parameters:**
- `frontiers` - Array of OpIds representing the target version

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const frontiers = doc.frontiers();
// Make some changes...
doc.checkout(frontiers); // Go back to previous version
```
</Indent>

<Method>
```typescript
checkoutToLatest(): void
```
</Method>
<Indent>
Returns the document to the latest version after a checkout.

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.checkoutToLatest();
```
</Indent>

<Method>
```typescript
attach(): void
```
</Method>
<Indent>
Attaches the document to track latest changes after being detached.

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.attach();
```
</Indent>

<Method>
```typescript
detach(): void
```
</Method>
<Indent>
Detaches the document from tracking latest changes, freezing it at current version.

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.detach();
```
</Indent>

<Method>
```typescript
fork(): LoroDoc
```
</Method>
<Indent>
Creates a new document that is a fork of the current one with a new peer ID.

**Returns:** A new LoroDoc instance

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const forkedDoc = doc.fork();
```
</Indent>

<Method>
```typescript
forkAt(frontiers: Frontiers): LoroDoc
```
</Method>
<Indent>
Creates a fork at a specific version in history.

**Parameters:**
- `frontiers` - The version to fork from

**Returns:** A new LoroDoc instance

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const frontiers = doc.frontiers();
const forkedDoc = doc.forkAt(frontiers);
```
</Indent>

### Subscription Methods

<Method>
```typescript
subscribe(listener: (event: LoroEventBatch) => void): () => void
```
</Method>
<Indent>
Subscribes to all document changes.

**Parameters:**
- `listener` - Callback function that receives change events

**Returns:** Unsubscribe function

**Event Structure:**
```typescript
interface LoroEventBatch {
  by: "local" | "import" | "checkout"
  origin?: string
  currentTarget?: ContainerID
  events: LoroEvent[]
  from: Frontiers
  to: Frontiers
}
```

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const unsubscribe = doc.subscribe((event) => {
  console.log("Change type:", event.by);
  event.events.forEach(e => {
    console.log("Container changed:", e.target);
    console.log("Diff:", e.diff);
  });
});

// Later: unsubscribe();
```
</Indent>

<Method>
```typescript
subscribeLocalUpdates(f: (bytes: Uint8Array) => void): () => void
```
</Method>
<Indent>
Subscribes only to local changes, useful for syncing with remote peers.

**Parameters:**
- `f` - Callback that receives binary updates

**Returns:** Unsubscribe function

**Example:**
```ts no_run twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
declare const websocket: { send: (data: Uint8Array) => void };
// ---cut---
const unsubscribe = doc.subscribeLocalUpdates((updates) => {
  // Send updates to remote peers
  websocket.send(updates);
});
```
</Indent>

<Method>
```typescript
subscribeFirstCommitFromPeer(f: (e: { peer: PeerID }) => void): () => void
```
</Method>
<Indent>
Subscribes to the first commit from each peer, useful for tracking peer metadata.

**Parameters:**
- `f` - Callback that receives peer information

**Returns:** Unsubscribe function

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.subscribeFirstCommitFromPeer(({ peer }) => {
  // Store peer metadata
  doc.getMap("peers").set(peer, {
    joinedAt: Date.now(),
    name: `User ${peer}`
  });
});
```
</Indent>

### Transaction Methods

#### commit

```typescript
commit(options?: { origin?: string, message?: string, timestamp?: number }): void
```

Commits pending changes as a single transaction.

**Parameters:**
- `options` - Optional commit configuration
  - `origin` - Origin identifier for the commit
  - `message` - Commit message
  - `timestamp` - Unix timestamp in seconds

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.commit({
  origin: "user-action",
  message: "Updated document title",
  timestamp: Math.floor(Date.now() / 1000)
});
```

### Query Methods

#### toJSON

```typescript
toJSON(): Value
```

Converts the entire document to a JSON-compatible value.

**Returns:** JSON representation of the document

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const json = doc.toJSON();
console.log(JSON.stringify(json, null, 2));
```

#### getShallowValue

```typescript
getShallowValue(): Record<string, ContainerID>
```

Gets a shallow representation where sub-containers are represented by their IDs.

**Returns:** Shallow JSON value

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const shallow = doc.getShallowValue();
// Sub-containers appear as: "cid:..."
```

#### version

```typescript
version(): VersionVector
```

Gets the current version vector of the document.

**Returns:** Map from PeerID to counter

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const vv = doc.version();
console.log(vv.toJSON());
```

#### frontiers

```typescript
frontiers(): Frontiers
```

Gets the current frontiers (heads) of the document.

**Returns:** Array of OpIds

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const frontiers = doc.frontiers();
// Can be used for checkouts or shallow snapshots
```

#### diff

```typescript
diff(from: Frontiers, to: Frontiers, for_json?: boolean): [ContainerID, Diff | JsonDiff][]
```

Calculates differences between two versions.

**Parameters:**
- `from` - Starting frontiers
- `to` - Ending frontiers  
- `for_json` - If true, returns JsonDiff format (default: true)

**Returns:** Array of container IDs and their diffs

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const fromFrontiers = doc.frontiers();
// Make changes...
const toFrontiers = doc.frontiers();

const diffs = doc.diff(fromFrontiers, toFrontiers);
diffs.forEach(([containerId, diff]) => {
  console.log(`Container ${containerId} changed:`, diff);
});
```

### Pre-Commit Hook

<Method>
```typescript
subscribePreCommit(f: (e: { changeMeta: Change, origin: string, modifier: ChangeModifier }) => void): () => void
```
</Method>
<Indent>
Subscribe to the pre-commit event. You can modify the message and timestamp of the next change.

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const unsubscribe = doc.subscribePreCommit(({ modifier }) => {
  modifier
    .setMessage("Tagged by pre-commit")
    .setTimestamp(Math.floor(Date.now() / 1000));
});
doc.getText("text").insert(0, "Hello");
doc.commit();
unsubscribe();
```
</Indent>

### Cursor Utilities

<Method>
```typescript
getCursorPos(cursor: Cursor): { update?: Cursor, offset: number, side: Side }
```
</Method>
<Indent>
Resolve a stable `Cursor` to an absolute position.

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const text = doc.getText("text");
// ---cut---
text.insert(0, "abc");
const c0 = text.getCursor(1);
const pos = doc.getCursorPos(c0!);
console.log(pos.offset); // 1
```
</Indent>

### Pending Operations

<Method>
```typescript
getUncommittedOpsAsJson(): JsonSchema | undefined
```
</Method>
<Indent>
Get pending operations from the current transaction in JSON format.

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const text = doc.getText("text");
// ---cut---
text.insert(0, "Hello");
const pending = doc.getUncommittedOpsAsJson();
doc.commit();
const none = doc.getUncommittedOpsAsJson(); // undefined after commit
```
</Indent>

### Change Graph & History

<Method>
```typescript
travelChangeAncestors(ids: OpId[], f: (change: Change) => boolean): void
```
</Method>
<Indent>
Visit ancestors of the given changes in causal order.

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.getText("text").insert(0, "Hello");
doc.commit();
const head = doc.frontiers();
doc.travelChangeAncestors(head, (change) => {
  console.log(change.peer, change.counter);
  return true; // continue
});
```
</Indent>

<Method>
```typescript
findIdSpansBetween(from: Frontiers, to: Frontiers): VersionVectorDiff
```
</Method>
<Indent>
Find the op id spans that lie between two versions.
</Indent>

<Method>
```typescript
exportJsonInIdSpan(idSpan: { peer: PeerID, counter: number, length: number }): JsonChange[]
```
</Method>
<Indent>
```ts twoslash
import { LoroDoc } from "loro-crdt";
const a = new LoroDoc();
const b = new LoroDoc();
// ---cut---
a.getText("text").update("Hello");
a.commit();
const snapshot = a.export({ mode: "snapshot" });
let printed: any;
b.subscribe((e) => {
  const spans = b.findIdSpansBetween(e.from, e.to);
  const changes = b.exportJsonInIdSpan(spans.forward[0]);
  printed = changes;
});
b.import(snapshot);
```
</Indent>

<Method>
```typescript
getChangedContainersIn(id: OpId, len: number): ContainerID[]
```
</Method>
<Indent>
Get container IDs modified in the given ID range.

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.getList("list").insert(0, 1);
doc.commit();
const head = doc.frontiers()[0];
const containers = doc.getChangedContainersIn(head, 1);
```
</Indent>

### Revert & Apply Diff

<Method>
```typescript
revertTo(frontiers: Frontiers): void
```
</Method>
<Indent>
Revert the document to a given version by generating inverse operations.

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.setPeerId("1");
const t = doc.getText("text");
t.update("Hello");
doc.commit();
doc.revertTo([{ peer: "1", counter: 1 }]);
```
</Indent>

<Method>
```typescript
applyDiff(diff: [ContainerID, Diff | JsonDiff][]): void
```
</Method>
<Indent>
Apply a batch of diffs to the document.

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc1 = new LoroDoc();
const doc2 = new LoroDoc();
// ---cut---
doc1.getText("text").insert(0, "Hello");
const diff = doc1.diff([], doc1.frontiers());
doc2.applyDiff(diff);
```
</Indent>

### Detached Editing

```typescript
setDetachedEditing(enable: boolean): void
isDetachedEditingEnabled(): boolean
isDetached(): boolean
detach(): void
attach(): void
```

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.setDetachedEditing(true);
doc.detach();
console.log(doc.isDetached());
doc.attach();
```

### Commit Options Helpers

```typescript
setNextCommitMessage(msg: string): void
setNextCommitOrigin(origin: string): void
setNextCommitTimestamp(timestamp: number): void
setNextCommitOptions(options: { origin?: string, timestamp?: number, message?: string }): void
clearNextCommitOptions(): void
```

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.setNextCommitOptions({ origin: "ui", message: "batch" });
doc.getText("text").insert(0, "Hi");
doc.commit();
doc.clearNextCommitOptions();
```

### Version & Frontier Utilities

```typescript
frontiersToVV(frontiers: Frontiers): VersionVector
vvToFrontiers(vv: VersionVector): Frontiers
oplogVersion(): VersionVector
oplogFrontiers(): Frontiers
cmpWithFrontiers(frontiers: Frontiers): -1 | 0 | 1
cmpFrontiers(a: Frontiers, b: Frontiers): -1 | 0 | 1 | undefined
```

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const vv = doc.oplogVersion();
const f = doc.vvToFrontiers(vv);
const vv2 = doc.frontiersToVV(f);
const cmp = doc.cmpFrontiers(doc.frontiers(), f);
```

### JSONPath & Path Queries

```typescript
getByPath(path: string): Value | Container | undefined
getPathToContainer(id: ContainerID): (string | number)[] | undefined
JSONPath(jsonpath: string): any[]
```

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
map.set("key", 1);
// ---cut---
const value = doc.getByPath("map/key");
const path = doc.getPathToContainer(map.id);
const results = doc.JSONPath("$.map");
```

### Shallow Doc Utilities

```typescript
shallowSinceVV(): VersionVector
shallowSinceFrontiers(): Frontiers
isShallow(): boolean
setHideEmptyRootContainers(hide: boolean): void
deleteRootContainer(cid: ContainerID): void
hasContainer(id: ContainerID): boolean
```

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.getMap("map");
doc.setHideEmptyRootContainers(true);
// Now empty roots are hidden in toJSON()
```

### JSON Serialization with Replacer

#### toJsonWithReplacer

```typescript
toJsonWithReplacer(replacer: (key: string | number, value: Value | Container) => Value | Container | undefined): Value
```

Customize JSON serialization of containers and values.

```ts twoslash
import { LoroDoc, LoroText } from "loro-crdt";
const doc = new LoroDoc();
const text = doc.getText("text");
text.insert(0, "Hello");
// ---cut---
const json = doc.toJsonWithReplacer((key, value) => {
  if (value instanceof LoroText) {
    return value.toDelta();
  }
  return value;
});
```

### Stats & Introspection

```typescript
debugHistory(): void
changeCount(): number
opCount(): number
getAllChanges(): Map<PeerID, Change[]>
getChangeAt(id: OpId): Change
getChangeAtLamport(peer_id: string, lamport: number): Change | undefined
getOpsInChange(id: OpId): any[]
getPendingTxnLength(): number
```

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.getText("text").insert(0, "x");
console.log(doc.getPendingTxnLength());
doc.commit();
console.log(doc.changeCount(), doc.opCount());
```

### Import/Export Utilities

```typescript
decodeImportBlobMeta(blob: Uint8Array, check_checksum: boolean): ImportBlobMetadata
redactJsonUpdates(json: string | JsonSchema, version_range: any): JsonSchema
```

```ts twoslash
import { LoroDoc, decodeImportBlobMeta, redactJsonUpdates } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const updates = doc.export({ mode: "update" });
const meta = decodeImportBlobMeta(updates, true);
const json = doc.exportJsonUpdates();
const redacted = redactJsonUpdates(json, { [doc.peerIdStr]: [0, 999999] });
```

---

## Container Types

### LoroText

A rich text container supporting collaborative text editing with formatting.


<Method>
```typescript
insert(index: number, text: string): void
```
</Method>

<Indent>
Inserts text at the specified position.

**Parameters:**
- `index` - Position to insert at (0-based)
- `text` - Text to insert

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const text = doc.getText("text");
// ---cut---
text.insert(0, "Hello ");
text.insert(6, "World");
```
</Indent>

<Method>
```typescript
delete(index: number, len: number): void
```
</Method>

<Indent>
Deletes text from the specified position.

**Parameters:**
- `index` - Starting position
- `len` - Number of characters to delete

**Example:**
```typescript
text.delete(5, 1); // Delete one character at position 5
```
</Indent>

<Method>
```typescript
mark(range: { start: number, end: number }, key: string, value: Value): void
```
</Method>

<Indent>
Applies formatting to a text range.

**Parameters:**
- `range` - The range to format
- `key` - Style attribute name
- `value` - Style value

**Example:**
```typescript
text.mark({ start: 0, end: 5 }, "bold", true);
text.mark({ start: 6, end: 11 }, "color", "#ff0000");
```
</Indent>

<Method>
```typescript
unmark(range: { start: number, end: number }, key: string): void
```
</Method>
<Indent>
Removes formatting from a text range.

**Parameters:**
- `range` - The range to unformat
- `key` - Style attribute to remove

**Example:**
```typescript
text.unmark({ start: 0, end: 5 }, "bold");
```
</Indent>

<Method>
```typescript
toDelta(): Delta<string>[]
```
</Method>
<Indent>
Converts text to Delta format (Quill-compatible).

**Returns:** Array of Delta operations

**Example:**
```typescript
const delta = text.toDelta();
// [{ insert: "Hello", attributes: { bold: true } }, { insert: " World" }]
```
</Indent>

<Method>
```typescript
applyDelta(delta: Delta<string>[]): void
```
</Method>
<Indent>
Applies Delta operations to the text.

**Parameters:**
- `delta` - Array of Delta operations

**Example:**
```typescript
text.applyDelta([
  { insert: "Hello", attributes: { bold: true } },
  { insert: " World" }
]);
```
</Indent>

<Method>
```typescript
update(text: string, options?: { timeoutMs?: number; useRefinedDiff?: boolean }): void
```
</Method>
<Indent>
Updates the current text to the target text using Myers' diff algorithm.

**Parameters:**
- `text` - New text content
- `options` - Update options
  - `timeoutMs` - Optional timeout for the diff computation
  - `useRefinedDiff` - Use refined diff for better quality on long texts

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const text = doc.getText("text");
// ---cut---
text.insert(0, "Hello");
text.update("Hello World", { timeoutMs: 100 });
```
</Indent>

<Method>
```typescript
updateByLine(text: string, options?: { timeoutMs?: number; useRefinedDiff?: boolean }): void
```
</Method>
<Indent>
Line-based update that's faster for large texts (less precise than `update`).

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const text = doc.getText("text");
// ---cut---
text.insert(0, "Line A\nLine C");
text.updateByLine("Line A\nLine B\nLine C");
```
</Indent>

<Method>
```typescript
getCursor(pos: number, side?: Side): Cursor | undefined
```
</Method>
<Indent>
Gets a stable cursor position that survives edits.

**Parameters:**
- `pos` - Position in the text
- `side` - Cursor affinity (-1, 0, or 1)

**Returns:** Cursor object or undefined

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const text = doc.getText("text");
// ---cut---
const cursor = text.getCursor(5);
// Cursor remains valid even after edits
```
</Indent>

<Method>
```typescript
toString(): string
```
</Method>
<Indent>
Converts to plain text string.

**Returns:** Plain text content

**Example:**
```typescript
const plainText = text.toString();
```
</Indent>

### LoroList

An ordered list container for collaborative arrays.

<Method>
```typescript
insert(pos: number, value: Value | Container): void
```
</Method>
<Indent>
Inserts a value at the specified position.

**Parameters:**
- `pos` - Insert position
- `value` - Value to insert

**Example:**
```typescript
list.insert(0, "First");
list.insert(1, { type: "object" });
```
</Indent>

<Method>
```typescript
insertContainer<T extends Container>(pos: number, container: T): T
```
</Method>
<Indent>
Inserts a new container at the position.

**Parameters:**
- `pos` - Insert position  
- `container` - Container instance

**Returns:** The inserted container

**Example:**
```typescript
const subText = list.insertContainer(0, new LoroText());
subText.insert(0, "Nested text");
```
</Indent>

<Method>
```typescript
delete(pos: number, len: number): void
```
</Method>
<Indent>
Deletes elements from the list.

**Parameters:**
- `pos` - Starting position
- `len` - Number of elements to delete

**Example:**
```typescript
list.delete(1, 2); // Delete 2 elements starting at index 1
```
</Indent>

<Method>
```typescript
push(value: Value | Container): void
```
</Method>
<Indent>
Appends a value to the end of the list.

**Parameters:**
- `value` - Value to append

**Example:**
```typescript
list.push("Last item");
```
</Indent>

<Method>
```typescript
getIdAt(pos: number): { peer: PeerID, counter: number } | undefined
```
</Method>
<Indent>
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const list = doc.getList("list");
// ---cut---
list.insert(0, 1);
const id0 = list.getIdAt(0);
```
</Indent>

<Method>
```typescript
pushContainer<T extends Container>(container: T): T
```
</Method>
<Indent>
Appends a container to the end of the list.

**Parameters:**
- `container` - Container to append

**Returns:** The appended container

**Example:**
```typescript
const map = list.pushContainer(new LoroMap());
map.set("key", "value");
```
</Indent>

<Method>
```typescript
pop(): Value | Container | undefined
```
</Method>
<Indent>
Removes and returns the last element.

**Returns:** The removed element or undefined

**Example:**
```ts no_run twoslash
import { LoroList } from "loro-crdt";
declare const list: LoroList;
// ---cut---
const lastItem = list.pop();
```
</Indent>

<Method>
```typescript
get(index: number): Value | Container | undefined
```
</Method>
<Indent>
Gets the value at the specified index.

**Parameters:**
- `index` - Element index

**Returns:** The value or undefined

**Example:**
```ts no_run twoslash
import { LoroList } from "loro-crdt";
declare const list: LoroList;
// ---cut---
const item = list.get(0);
```
</Indent>

<Method>
```typescript
getCursor(pos: number, side?: Side): Cursor | undefined
```
</Method>
<Indent>
Gets a stable cursor for the position.

**Parameters:**
- `pos` - Position in the list
- `side` - Cursor affinity

**Returns:** Cursor object or undefined

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const list = doc.getList("list");
// ---cut---
const cursor = list.getCursor(2);
```
</Indent>

<Method>
```typescript
toArray(): (Value | Container)[]
```
</Method>
<Indent>
Converts the list to a JavaScript array.

**Returns:** Array of values

**Example:**
```typescript
const array = list.toArray();
```
</Indent>

<Method>
```typescript
clear(): void
```
</Method>
<Indent>
Removes all elements from the list.

**Example:**
```typescript
list.clear();
```
</Indent>

<Method>
```typescript
length: number
```
</Method>
<Indent>
Gets the number of elements in the list.

**Returns:** List length

**Example:**
```typescript
console.log(`List has ${list.length} items`);
```
</Indent>

### LoroMap

A key-value map container for collaborative objects.

<Method>
```typescript
set(key: string, value: Value | Container): void
```
</Method>
<Indent>
Sets a key-value pair.

**Parameters:**
- `key` - The key
- `value` - The value

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
map.set("name", "Alice");
map.set("age", 30);
```
</Indent>

<Method>
```typescript
setContainer<T extends Container>(key: string, container: T): T
```
</Method>
<Indent>
Sets a container as the value for a key.

**Parameters:**
- `key` - The key
- `container` - Container instance

**Returns:** The set container

**Example:**
```ts twoslash
import { LoroDoc, LoroList } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
const list = map.setContainer("items", new LoroList());
list.push("item1");
```
</Indent>

<Method>
```typescript
get(key: string): Value | Container | undefined
```
</Method>
<Indent>
Gets the value for a key.

**Parameters:**
- `key` - The key

**Returns:** The value or undefined

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
const name = map.get("name");
```
</Indent>

<Method>
```typescript
getOrCreateContainer<T extends Container>(key: string, container: T): T
```
</Method>
<Indent>
Gets an existing container or creates a new one.

**Parameters:**
- `key` - The key
- `container` - Container to create if not exists

**Returns:** The container

**Example:**
```ts twoslash
import { LoroDoc, LoroText } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
const text = map.getOrCreateContainer("description", new LoroText());
```
</Indent>

<Method>
```typescript
delete(key: string): void
```
</Method>
<Indent>
Removes a key-value pair.

**Parameters:**
- `key` - The key to remove

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
map.delete("obsoleteKey");
```
</Indent>

<Method>
```typescript
clear(): void
```
</Method>
<Indent>
Removes all key-value pairs.

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
map.clear();
```
</Indent>

<Method>
```typescript
keys(): string[]
```
</Method>
<Indent>
Gets all keys in the map.

**Returns:** Array of keys

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
const allKeys = map.keys();
```
</Indent>

<Method>
```typescript
values(): (Value | Container)[]
```
</Method>
<Indent>
Gets all values in the map.

**Returns:** Array of values

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
const allValues = map.values();
```
</Indent>

<Method>
```typescript
entries(): [string, Value | Container][]
```
</Method>
<Indent>
Gets all key-value pairs.

**Returns:** Array of entries

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
for (const [key, value] of map.entries()) {
  console.log(`${key}: ${value}`);
}
```
</Indent>

<Method>
```typescript
getLastEditor(key: string): PeerID | undefined
```
</Method>
<Indent>
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
map.set("k", 1);
doc.commit();
const who = map.getLastEditor("k");
```
</Indent>

<Method>
```typescript
size: number
```
</Method>
<Indent>
Gets the number of key-value pairs.

**Returns:** Map size

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
console.log(`Map has ${map.size} entries`);
```
</Indent>

### LoroTree

A hierarchical tree container for nested structures.

<Method>
```typescript
createNode(parent?: TreeID, index?: number): LoroTreeNode
```
</Method>
<Indent>
Creates a new tree node.

**Parameters:**
- `parent` - Parent node ID (optional, creates root if omitted)
- `index` - Position among siblings (optional)

**Returns:** The new node's handler

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
// ---cut---
const root = tree.createNode();
const child = root.createNode(0);
```
</Indent>

<Method>
```typescript
move(target: TreeID, parent?: TreeID, index?: number): void
```
</Method>
<Indent>
Moves a node to a new position.

**Parameters:**
- `target` - Node to move
- `parent` - New parent (undefined for root)
- `index` - Position among siblings

**Example:**
```ts twoslash
import { LoroDoc, TreeID } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
declare const nodeId: TreeID;
declare const newParentId: TreeID;
// ---cut---
tree.move(nodeId, newParentId, 0);
```
</Indent>

<Method>
```typescript
delete(target: TreeID): void
```
</Method>
<Indent>
Deletes a node and its descendants.

**Parameters:**
- `target` - Node to delete

**Example:**
```ts twoslash
import { LoroDoc, TreeID } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
declare const nodeId: TreeID;
// ---cut---
tree.delete(nodeId);
```
</Indent>

<Method>
```typescript
getNodeByID(id: TreeID): LoroTreeNode | undefined
```
</Method>
<Indent>
Gets a node handler by its ID.

**Parameters:**
- `id` - Node ID

**Returns:** Node handler or undefined

**Example:**
```ts twoslash
import { LoroDoc, TreeID } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
declare const nodeId: TreeID;
// ---cut---
const node = tree.getNodeByID(nodeId);
if (node) {
  node.data.set("label", "New Label");
}
```
</Indent>

<Method>
```typescript
nodes(): LoroTreeNode[]
```
</Method>
<Indent>
Gets all nodes in the tree.

**Returns:** Array of all nodes

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
// ---cut---
const allNodes = tree.nodes();
```
</Indent>

<Method>
```typescript
roots(): LoroTreeNode[]
```
</Method>
<Indent>
Gets all root nodes.

**Returns:** Array of root nodes

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
// ---cut---
const rootNodes = tree.roots();
```
</Indent>

<Method>
```typescript
has(target: TreeID): boolean
```
</Method>
<Indent>  
Checks if a node exists.

**Parameters:**
- `target` - Node ID to check

**Returns:** Boolean indicating existence

**Example:**
```ts twoslash
import { LoroDoc, TreeID } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
declare const nodeId: TreeID;
// ---cut---
if (tree.has(nodeId)) {
  console.log("Node exists");
}
```
</Indent>

<Method>
```typescript
isNodeDeleted(target: TreeID): boolean
```
</Method>
<Indent>
Checks if a node has been deleted.

**Parameters:**
- `target` - Node ID to check

**Returns:** Boolean indicating deletion status

**Example:**
```ts twoslash
import { LoroDoc, TreeID } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
declare const nodeId: TreeID;
// ---cut---
if (tree.isNodeDeleted(nodeId)) {
  console.log("Node was deleted");
}
```
</Indent>
#### LoroTreeNode

Represents a single node in the tree.

<Method>
```typescript
data: LoroMap
```
</Method>
<Indent>
A map container for storing node metadata.

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const node = tree.createNode();
node.data.set("title", "Node Title");
node.data.set("expanded", true);
```
</Indent>

<Method>
```typescript
createNode(index?: number): LoroTreeNode
```
</Method>
<Indent>
Creates a child node.

**Parameters:**
- `index` - Position among siblings

**Returns:** New node's handler

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const node = tree.createNode();
const childId = node.createNode(0);
```
</Indent>

<Method>
```typescript
move(parent?: LoroTreeNode, index?: number): void
```
</Method>
<Indent>
Moves this node to a new parent.

**Parameters:**
- `parent` - New parent node
- `index` - Position among siblings

**Example:**
```ts twoslash
import { LoroDoc, LoroTreeNode } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const node = tree.createNode();
const parent = tree.createNode();
// ---cut---
node.move(parent, 0);
```
</Indent>

<Method>
```typescript
moveAfter(target: LoroTreeNode): void
```
</Method>
<Indent>
Moves this node after a sibling.

**Parameters:**
- `target` - Sibling node

**Example:**
```ts twoslash
import { LoroDoc, LoroTreeNode } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const node = tree.createNode();
const sibling = tree.createNode();
// ---cut---
node.moveAfter(sibling);
```
</Indent> 

<Method>
```typescript
moveBefore(target: LoroTreeNode): void
```
</Method>
<Indent>
Moves this node before a sibling.

**Parameters:**
- `target` - Sibling node

**Example:**
```ts twoslash
import { LoroDoc, LoroTreeNode } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const node = tree.createNode();
const sibling = tree.createNode();
// ---cut---
node.moveBefore(sibling);
```
</Indent>

<Method>
```typescript
parent(): LoroTreeNode | undefined
```
</Method>
<Indent>
Gets the parent node.

**Returns:** Parent node or undefined

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const node = tree.createNode();
// ---cut---
const parentNode = node.parent();
```
</Indent>

<Method>
```typescript
children(): LoroTreeNode[]
```
</Method>
<Indent>
Gets all child nodes.

**Returns:** Array of children

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const node = tree.createNode();
// ---cut---
const childNodes = node.children();
```
</Indent>

<Method>
```typescript
index(): number | undefined
```
</Method>
<Indent>
Gets the position among siblings.

**Returns:** Index or undefined if root

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const node = tree.createNode();
// ---cut---
const position = node.index();
```
</Indent>

<Method>
```typescript
fractionalIndex(): string | undefined
creationId(): { peer: PeerID, counter: number }
creator(): PeerID
getLastMoveId(): { peer: PeerID, counter: number } | undefined
```
</Method>
<Indent>
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const root = tree.createNode();
const node = root.createNode();
// ---cut---
const fi = node.fractionalIndex();
const create = node.creationId();
const author = node.creator();
const lastMove = node.getLastMoveId();
```
</Indent>

<Method>
```typescript
isDeleted(): boolean
```
</Method>
<Indent>  
Checks if this node has been deleted.

**Returns:** Boolean deletion status

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const node = tree.createNode();
// ---cut---
if (node.isDeleted()) {
  console.log("Node is deleted");
}
```
</Indent>

### LoroCounter

A counter CRDT for collaborative numeric values.

<Method>
```typescript
increment(value: number): void
```
</Method>
<Indent>
Increments the counter.

**Parameters:**
- `value` - Amount to increment (default: 1)

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const counter = doc.getCounter("counter");
// ---cut---
counter.increment(5);   // +5
```
</Indent>

<Method>
```typescript
decrement(value: number): void
```
</Method>
<Indent>
Decrements the counter.

**Parameters:**
- `value` - Amount to decrement (default: 1)

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const counter = doc.getCounter("counter");
// ---cut---
counter.decrement(3);   // -3
```
</Indent>

<Method>
```typescript
value: number
```
</Method>
<Indent>
Gets the current counter value.

**Returns:** Current numeric value

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const counter = doc.getCounter("counter");
// ---cut---
console.log(`Counter value: ${counter.value}`);
```
</Indent>

### LoroMovableList

A list optimized for move operations.

Extends `LoroList` with additional methods for efficient element reordering.

<Method>
```typescript
move(from: number, to: number): void
```
</Method>
<Indent>
Moves an element from one position to another.

**Parameters:**
- `from` - Source index
- `to` - Target index

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const movableList = doc.getMovableList("list");
// ---cut---
movableList.move(0, 3); // Move first element to fourth position
```
</Indent>

<Method>
```typescript
set(pos: number, value: Value | Container): void
```
</Method>
<Indent>  
Replaces the value at a position.

**Parameters:**
- `pos` - Position to update
- `value` - New value

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const movableList = doc.getMovableList("list");
// ---cut---
movableList.set(0, "Updated value");
```
</Indent>

<Method>
```typescript
setContainer<T extends Container>(pos: number, container: T): T
```
</Method>
<Indent>  
Replaces the value with a container.

**Parameters:**
- `pos` - Position to update
- `container` - New container

**Returns:** The set container

**Example:**
```ts twoslash
import { LoroDoc, LoroText } from "loro-crdt";
const doc = new LoroDoc();
const movableList = doc.getMovableList("list");
// ---cut---
const text = movableList.setContainer(0, new LoroText());
```
</Indent> 

## Synchronization

### Import/Export Patterns

#### Basic Synchronization

```ts twoslash
import { LoroDoc } from "loro-crdt";
// ---cut---
// Peer A: Export updates
const doc1 = new LoroDoc();
doc1.getText("text").insert(0, "Hello");
const updates = doc1.export({ mode: "update" });

// Peer B: Import updates
const doc2 = new LoroDoc();
doc2.import(updates);
```

#### Continuous Sync

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc1 = new LoroDoc();
const doc2 = new LoroDoc();
// ---cut---
// Set up bidirectional sync
doc1.subscribeLocalUpdates((updates) => {
  doc2.import(updates);
});

doc2.subscribeLocalUpdates((updates) => {
  doc1.import(updates);
});
```

#### Network Sync with WebSocket

```ts no_run twoslash
import { LoroDoc } from "loro-crdt";
declare const ws: { 
  send: (data: Uint8Array) => void;
  on: (event: string, handler: (data: any) => void) => void;
};
// ---cut---
// Client side
const doc = new LoroDoc();

// Send local updates to server
doc.subscribeLocalUpdates((updates) => {
  ws.send(updates);
});

// Receive updates from server
ws.on('message', (data) => {
  doc.import(new Uint8Array(data));
});
```

### Shallow Snapshots

Shallow snapshots allow for efficient storage by garbage collecting deleted operations.

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
// Create shallow snapshot
const frontiers = doc.frontiers();
const shallowSnapshot = doc.export({
  mode: "shallow-snapshot",
  frontiers: frontiers
});

// Import shallow snapshot
const newDoc = new LoroDoc();
newDoc.import(shallowSnapshot);
```

---

## Version Control

### Time Travel

Navigate through document history:

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
// Save current version
const v1 = doc.frontiers();

// Make changes
doc.getText("text").insert(0, "New text");

// Save new version
const v2 = doc.frontiers();

// Travel back
doc.checkout(v1);
console.log(doc.getText("text").toString()); // Original text

// Travel forward
doc.checkout(v2);
console.log(doc.getText("text").toString()); // New text

// Return to latest
doc.checkoutToLatest();
```

### Forking

Create document branches:

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
// Fork at current state
const fork1 = doc.fork();
fork1.getText("text").insert(0, "Fork 1 changes");

// Fork at specific version
const historicalVersion = doc.frontiers();
const fork2 = doc.forkAt(historicalVersion);
fork2.getText("text").insert(0, "Fork 2 changes");

// Original document remains unchanged
```

### Version Vectors

Track document versions:

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const vv = doc.version();
console.log(`Document has ${vv.length()} peers`);
```

---

## Events & Subscriptions

### Event Structure

```typescript
interface LoroEventBatch {
  by: "local" | "import" | "checkout"
  origin?: string
  currentTarget?: ContainerID
  events: LoroEvent[]
  from: Frontiers
  to: Frontiers
}

interface LoroEvent {
  target: ContainerID
  diff: Diff
  path: Path
}
```

### Diff Types

Different containers produce different diff types:

#### TextDiff

```typescript
type TextDiff = {
  type: "text"
  diff: Delta<string>[]
}
```

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const text = doc.getText("text");
// ---cut---
// Example
text.subscribe((e) => {
  for (const event of e.events) {
    if (event.diff.type === "text") {
      event.diff.diff.forEach(delta => {
        if (delta.insert) {
          console.log(`Inserted: "${delta.insert}"`);
        }
        if (delta.delete) {
          console.log(`Deleted ${delta.delete} characters`);
        }
      });
    }
  }
});
```

#### ListDiff

```typescript
type ListDiff = {
  type: "list"
  diff: Delta<(Value | Container)[]>[]
}
```

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const list = doc.getList("list");
// ---cut---
// Example
list.subscribe((e) => {
  for (const event of e.events) {
    if (event.diff.type === "list") {
      event.diff.diff.forEach(delta => {
        if (delta.insert) {
          console.log(`Inserted items:`, delta.insert);
        }
      });
    }
  }
});
```

#### MapDiff

```typescript
type MapDiff = {
  type: "map"
  updated: Record<string, Value | Container | undefined>
}
```

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
// Example
map.subscribe((e) => {
  for (const event of e.events) {
    if (event.diff.type === "map") {
      Object.entries(event.diff.updated).forEach(([key, value]) => {
        if (value === undefined) {
          console.log(`Deleted key: ${key}`);
        } else {
          console.log(`Updated key: ${key} = ${value}`);
        }
      });
    }
  }
});
```

#### TreeDiff

```typescript
type TreeDiff = {
  type: "tree"
  diff: TreeDiffItem[]
}

type TreeDiffItem =
  | {
      target: TreeID
      action: "create"
      parent: TreeID | undefined
      index: number
      fractionalIndex: string
    }
  | {
      target: TreeID
      action: "delete"
      oldParent: TreeID | undefined
      oldIndex: number
    }
  | {
      target: TreeID
      action: "move"
      parent: TreeID | undefined
      index: number
      fractionalIndex: string
      oldParent: TreeID | undefined
      oldIndex: number
    }
```

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
// ---cut---
// Example
tree.subscribe((e) => {
  for (const event of e.events) {
    if (event.diff.type === "tree") {
      event.diff.diff.forEach(item => {
        switch (item.action) {
          case "create":
            console.log(`Created node ${item.target}`);
            break;
          case "move":
            console.log(`Moved node ${item.target}`);
            break;
          case "delete":
            console.log(`Deleted node ${item.target}`);
            break;
        }
      });
    }
  }
});
```

### Deep Subscription

Subscribe to nested changes:

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
// Subscribe to specific container
const text = doc.getText("text");
text.subscribe((event) => {
  console.log("Text changed:", event);
});

// Subscribe with deep observation
doc.subscribe((event) => {
  // Path shows the location of the change
  event.events.forEach(e => {
    console.log("Change path:", e.path);
    console.log("Container:", e.target);
    console.log("Diff:", e.diff);
  });
});
```

---

## Undo/Redo

### UndoManager

Provides local undo/redo functionality:

```ts twoslash
import { LoroDoc, UndoManager } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
// Create undo manager
const undo = new UndoManager(doc, {
  mergeInterval: 1000,        // Merge changes within 1 second
  maxUndoSteps: 100,          // Maximum undo stack size
  excludeOriginPrefixes: ["sync-"],  // Ignore changes with these origins
});

// Perform undo/redo
if (undo.canUndo()) {
  undo.undo();
}

if (undo.canRedo()) {
  undo.redo();
}
```

### Grouping Operations

Group multiple operations into a single undo step:

```ts twoslash
import { LoroDoc, UndoManager } from "loro-crdt";
const doc = new LoroDoc();
const undo = new UndoManager(doc, {});
const text = doc.getText("text");
const map = doc.getMap("map");
// ---cut---
undo.groupStart();
text.insert(0, "Hello");
doc.commit();
map.set("key", "value");
doc.commit();
undo.groupEnd();

// All three operations will be undone together
undo.undo();
```

### Custom Undo Handlers

Handle cursor restoration and side effects:

```ts twoslash
import { LoroDoc, UndoManager } from "loro-crdt";
const doc = new LoroDoc();
declare function saveCursorPositions(): any;
declare function restoreCursorPositions(cursors: any): void;
// ---cut---
const undo = new UndoManager(doc, {
  onPush: (isUndo, counterRange, event) => {
    // Save cursor positions when adding to undo stack
    const cursors = saveCursorPositions();
    return {
      value: doc.toJSON(),
      cursors: cursors
    };
  },
  
  onPop: (isUndo, { value, cursors }, counterRange) => {
    // Restore cursor positions when undoing
    restoreCursorPositions(cursors);
  }
});
```

---

## Types & Interfaces

### Core Types

```typescript
// Peer identifier
type PeerID = `${number}`

// Container identifier
type ContainerID = 
  | `cid:root-${string}:${ContainerType}`
  | `cid:${number}@${PeerID}:${ContainerType}`

// Tree node identifier
type TreeID = `${number}@${PeerID}`

// Operation identifier
type OpId = { 
  peer: PeerID
  counter: number 
}

// Container types
type ContainerType = "Text" | "Map" | "List" | "Tree" | "MovableList" | "Counter"

// Value types
type Value =
  | ContainerID
  | string
  | number
  | boolean
  | null
  | { [key: string]: Value }
  | Uint8Array
  | Value[]
  | undefined
```

### Version Types

```typescript
// Version vector class
class VersionVector {
  constructor(value: Map<PeerID, number> | Uint8Array | VersionVector | undefined | null)
  static parseJSON(version: Map<PeerID, number>): VersionVector
  toJSON(): Map<PeerID, number>
  encode(): Uint8Array
  static decode(bytes: Uint8Array): VersionVector
  get(peer_id: number | bigint | `${number}`): number | undefined
  compare(other: VersionVector): number | undefined
  setEnd(id: { peer: PeerID, counter: number }): void
  setLast(id: { peer: PeerID, counter: number }): void
  remove(peer: PeerID): void
  length(): number
}

// Frontiers represent a specific version
type Frontiers = OpId[]

// ID span for range queries
type IdSpan = {
  peer: PeerID
  counter: number
  length: number
}
```

### Change Types

```typescript
// Change metadata
interface Change {
  peer: PeerID
  counter: number
  lamport: number
  length: number
  timestamp: number  // Unix timestamp in seconds
  deps: OpId[]
  message: string | undefined
}

// Change modifier for pre-commit hooks
interface ChangeModifier {
  setMessage(message: string): this
  setTimestamp(timestamp: number): this
}
```

### Cursor Types

```typescript
// Stable position in containers
class Cursor {
  containerId(): ContainerID
  pos(): OpId | undefined
  side(): Side  // -1 | 0 | 1
  encode(): Uint8Array
  static decode(data: Uint8Array): Cursor
}

// Cursor side affinity
type Side = -1 | 0 | 1
```

### Delta Type

```typescript
// Rich text delta operations
type Delta<T> =
  | {
      insert: T
      attributes?: { [key in string]: {} }
      retain?: undefined
      delete?: undefined
    }
  | {
      delete: number
      attributes?: undefined
      retain?: undefined
      insert?: undefined
    }
  | {
      retain: number
      attributes?: { [key in string]: {} }
      delete?: undefined
      insert?: undefined
    }
```

---

## Utility Functions

### Type Checking

```ts twoslash
import { LoroDoc, isContainer, isContainerId, getType } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
// Check if value is a container
const map = doc.getMap("map");
console.log(isContainer(map));        // true
console.log(isContainer("string"));   // false

// Check if string is a container ID
console.log(isContainerId("cid:root-map:Map"));  // true
console.log(isContainerId("regular-string"));     // false

// Get type of value
console.log(getType(map));           // "Map"
console.log(getType("string"));      // "Json"
console.log(getType(doc.getText("text")));  // "Text"
```

### ID Creation

```ts twoslash
import { newContainerID, newRootContainerID } from "loro-crdt";
// ---cut---
// Create container ID from operation ID
const opId = { peer: "1" as const, counter: 100 };
const containerId = newContainerID(opId, "List");
// "cid:100@1:List"

// Create root container ID
const rootId = newRootContainerID("myMap", "Map");
// "cid:root-myMap:Map"
```

### ID Parsing

```ts twoslash
import { idStrToId } from "loro-crdt";
// ---cut---
const op = idStrToId("0@1"); // { peer: "1", counter: 0 }
```

### Frontier Encoding

```ts twoslash
import { LoroDoc, encodeFrontiers, decodeFrontiers } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
// Encode frontiers for transmission
const frontiers = doc.frontiers();
const encoded = encodeFrontiers(frontiers);

// Decode frontiers
const decoded = decodeFrontiers(encoded);
```

---

## EphemeralStore

Manages ephemeral state like cursor positions and user presence:

```ts no_run twoslash
import { EphemeralStore } from "loro-crdt";
declare const websocket: {
  send: (data: Uint8Array) => void;
  on: (event: string, handler: (data: any) => void) => void;
};
// ---cut---
// Create ephemeral store with 30 second timeout
const store = new EphemeralStore(30000);

// Set ephemeral values
store.set("cursor", { line: 10, column: 5 });
store.set("selection", { start: 0, end: 10 });
store.set("user", { name: "Alice", color: "#ff0000" });

// Get values
const cursor = store.get("cursor");

// Subscribe to changes
store.subscribe((event) => {
  console.log("Ephemeral state changed:", event);
});

// Subscribe to local updates for syncing
store.subscribeLocalUpdates((data) => {
  // Send to remote peers
  websocket.send(data);
});

// Apply remote updates
websocket.on('message', (data) => {
  store.apply(new Uint8Array(data));
});

// Clean up
store.destroy();
```

---

## Awareness (deprecated)

The `Awareness` class is deprecated in favor of `EphemeralStore`. Prefer using `EphemeralStore` for presence and cursor synchronization.

```ts no_run twoslash
import { Awareness } from "loro-crdt";
// ---cut---
const awareness = new Awareness("1", 30000);
// Use EphemeralStore instead for new code
```

</div>
