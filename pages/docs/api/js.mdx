import styles from './api-reference.module.css'
import Indent from './indent';
import Method from './method';

<div className={styles.apiReference}>

# API Reference

## Overview

Loro is a powerful Conflict-free Replicated Data Type (CRDT) library that enables real-time collaboration. If CRDTs are new to you, start with [What are CRDTs](/docs/concepts/crdt) for a gentle intro. This API reference provides comprehensive documentation for all classes, methods, and types available in the JavaScript/TypeScript binding.

## Quick Navigation

- [**LoroDoc**](#lorodoc) - The main document class for managing CRDT state
- [**Container Types**](#container-types) - Data structures (Text, List, Map, Tree, Counter, MovableList)
- [**Synchronization**](#synchronization) - Import/export and real-time sync
- [**Version Control**](#version-control) - Time travel, checkouts, and forks
- [**Events & Subscriptions**](#events--subscriptions) - Change tracking and reactivity
- [**Undo/Redo**](#undoredo) - Local undo management
- [**Types & Interfaces**](#types--interfaces) - TypeScript type definitions

## Basic Usage

```typescript twoslash
import { LoroDoc } from "loro-crdt";

const doc = new LoroDoc();
const text = doc.getText("text");
text.insert(0, "Hello World");

// Subscribe to changes
const unsubscribe = doc.subscribe((event) => {
  console.log("Document changed:", event);
});

// Export updates for synchronization
const updates = doc.export({ mode: "update" });
```

---

## LoroDoc

The `LoroDoc` class is the central document that manages all CRDT containers and provides synchronization capabilities. For a guided introduction, see [Loro Document](/docs/tutorial/loro_doc) and the [Container](/docs/concepts/container) concept.

### Constructor

```typescript
new LoroDoc()
```

Creates a new Loro document with a randomly generated peer ID.

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
// ---cut---
const doc = new LoroDoc();
```

### Configuration Methods

<Method>
```typescript
setPeerId(peer: number | bigint | `${number}`): void
```
</Method>
<Indent>
Sets the peer ID for this document. It must be a number, a BigInt, or a decimal string that fits into an unsigned 64-bit integer. New to Peer IDs? See [PeerID Management](/docs/concepts/peerid_management) for why uniqueness matters in distributed systems.

**Parameters:**
- `peer` - Peer ID as number, bigint, or decimal string

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.setPeerId("42");
```
</Indent>

<Method>
```typescript
setRecordTimestamp(auto_record: boolean): void
```
</Method>
<Indent>
Configures whether to automatically record timestamps for changes. Timestamps use Unix time (seconds since epoch). Learn more about storing timestamps and typical use cases in [Storing Timestamps](/docs/advanced/timestamp).

**Parameters:**
- `auto_record` - Whether to automatically record timestamps

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.setRecordTimestamp(true);
```
</Indent>

<Method>
```typescript
setChangeMergeInterval(interval: number): void
```
</Method>
<Indent>
Sets the interval in seconds for merging continuous local changes into a single change record. In Loro, multiple low-level operations are grouped into higher-level Changes for readability and syncing. See [Operations and Changes](/docs/concepts/operations_changes).

**Parameters:**
- `interval` - Merge interval in seconds

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.setChangeMergeInterval(1000); // Merge changes within 1 second
```
</Indent>

<Method>
```typescript
configTextStyle(styles: StyleConfig): void
```
</Method>
<Indent>
Configures the behavior of text styles (marks) in rich text containers. Marks can expand when edits happen at their edges (before/after/both/none). For a primer on rich text and marks in Loro, see [Text](/docs/tutorial/text).

**Parameters:**
- `styles` - Configuration object mapping style names to their config

**StyleConfig Type:**
```typescript
type StyleConfig = Record<string, {
  expand?: "after" | "before" | "both" | "none"
}>
```

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.configTextStyle({
  bold: { expand: "after" },
  italic: { expand: "none" },
  link: { expand: "none" }
});
```
</Indent>

### Container Access Methods

<Method>
```typescript
getText(name: string): LoroText
```
</Method>
<Indent>
Gets or creates a text container with the given name. New to LoroText and marks? See [Text](/docs/tutorial/text).

**Parameters:**
- `name` - The container name

**Returns:** A `LoroText` instance

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const text = doc.getText("content");
text.insert(0, "Hello");
```
</Indent>

<Method>
```typescript
getList(name: string): LoroList
```
</Method>
<Indent>
Gets or creates a list container with the given name. Unsure whether to use List or MovableList? See [List and Movable List](/docs/tutorial/list) and the type selection guide [Choosing CRDT Types](/docs/concepts/choose_crdt_type).

**Parameters:**
- `name` - The container name  

**Returns:** A `LoroList` instance

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const list = doc.getList("items");
list.push("Item 1");
```
</Indent>

<Method>
```typescript
getMap(name: string): LoroMap
```
</Method>
<Indent>
Gets or creates a map container with the given name. See [Map](/docs/tutorial/map) for basics and patterns.

**Parameters:**
- `name` - The container name

**Returns:** A `LoroMap` instance

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const map = doc.getMap("settings");
map.set("theme", "dark");
```
</Indent>

<Method>
```typescript
getTree(name: string): LoroTree
```
</Method>
<Indent>
Gets or creates a tree container with the given name. Learn about hierarchical editing and moves in [Tree](/docs/tutorial/tree).

**Parameters:**
- `name` - The container name

**Returns:** A `LoroTree` instance

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const tree = doc.getTree("fileSystem");
const root = tree.createNode();
```
</Indent>

<Method>
```typescript
getCounter(name: string): LoroCounter
```
</Method>
<Indent>
Gets or creates a counter container with the given name. Counters are special CRDTs that sum concurrent increments; see [Counter](/docs/tutorial/counter).

**Parameters:**
- `name` - The container name

**Returns:** A `LoroCounter` instance

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const counter = doc.getCounter("likes");
counter.increment(1);
```
</Indent>

<Method>
```typescript
getMovableList(name: string): LoroMovableList
```
</Method>
<Indent>
Gets or creates a movable list container with the given name. MovableList is designed for reordering with concurrent moves. See [List and Movable List](/docs/tutorial/list) and [Choosing CRDT Types](/docs/concepts/choose_crdt_type).

**Parameters:**
- `name` - The container name

**Returns:** A `LoroMovableList` instance

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const movableList = doc.getMovableList("tasks");
movableList.push("Task 1");
movableList.move(0, 2); // Move first item to third position
```
</Indent>

<Method>
```typescript
getContainerById(id: ContainerID): Container | undefined
```
</Method>
<Indent>
Gets a container by its unique ID. Container IDs (CID) uniquely reference containers across updates; see [Container ID](/docs/advanced/cid) and [Container](/docs/concepts/container).

**Parameters:**
- `id` - The container ID

**Returns:** The container instance or undefined if not found

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const text = doc.getText("text");
const textId = text.id;
const sameText = doc.getContainerById(textId);
```
</Indent>

### Import/Export Methods

<Method>
```typescript
export(mode?: ExportMode): Uint8Array
```
</Method>
<Indent>
Exports the document in various formats for synchronization or persistence. For a walkthrough of export modes—snapshot, update, shallow-snapshot, and updates-in-range—see [Export Mode](/docs/tutorial/encoding). Shallow snapshots remove history while keeping current state; see [Shallow Snapshots](/docs/concepts/shallow_snapshots). VersionVector and Frontiers are two ways to represent versions; see [Version Vector](/docs/concepts/version_vector) and [Frontiers](/docs/concepts/frontiers).

**Parameters:**
- `mode` - Export configuration (optional)

**ExportMode Options:**
```typescript
type ExportMode = 
  | { mode: "snapshot" }
  | { mode: "update", from?: VersionVector }
  | { mode: "shallow-snapshot", frontiers: Frontiers }
  | { mode: "updates-in-range", spans: { id: OpId; len: number }[] }
```

**Returns:** Encoded binary data

**Examples:**
```ts twoslash
import { LoroDoc, VersionVector } from "loro-crdt";
const doc = new LoroDoc();
declare const lastSyncVersion: VersionVector;
// ---cut---
// Export full snapshot
const snapshot = doc.export({ mode: "snapshot" });

// Export updates from a specific version
const updates = doc.export({ 
  mode: "update", 
  from: lastSyncVersion 
});

// Export shallow snapshot at current version
const shallowSnapshot = doc.export({ 
  mode: "shallow-snapshot",
  frontiers: doc.frontiers()
});
```
</Indent>

<Method>
```typescript
import(data: Uint8Array): ImportStatus
```
</Method>
<Indent>
Imports updates or snapshots into the document. Returns an `ImportStatus` describing which peer ranges were applied or are pending. See [Sync](/docs/tutorial/sync) and [Import Status](/docs/concepts/import_status) for how Loro handles out-of-order and partial updates.

**Parameters:**
- `data` - Binary data or another LoroDoc to import from

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
declare const updates: Uint8Array;
// ---cut---
// Import binary updates
const status = doc.import(updates);
console.log(status.success);
```
</Indent>

<Method>
```typescript
importBatch(data: Uint8Array[]): ImportStatus
```
</Method>
<Indent>
Efficiently imports multiple updates in a single batch operation. See [Batch Import](/docs/advanced/import_batch) for performance considerations and usage.

**Parameters:**
- `data` - Array of binary updates

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
declare const update1: Uint8Array;
declare const update2: Uint8Array;
declare const update3: Uint8Array;
// ---cut---
const updates = [update1, update2, update3];
const status = doc.importBatch(updates);
```
</Indent>

<Method>
```typescript
exportJsonUpdates(start?: VersionVector, end?: VersionVector, withPeerCompression?: boolean): JsonSchema
```
</Method>
<Indent>
Exports updates in JSON format for debugging or alternative storage. See [Export Mode](/docs/tutorial/encoding) for format details and trade-offs.

**Parameters:**
- `start` - Starting version (optional)
- `end` - Ending version (optional)

**Returns:** JSON representation of updates

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const jsonUpdates = doc.exportJsonUpdates();
console.log(JSON.stringify(jsonUpdates, null, 2));
```
</Indent>

<Method>
```typescript
importJsonUpdates(json: string | JsonSchema): void
```
</Method>
<Indent>
Imports updates from JSON format. Useful for debugging, migration, or custom storage layers; see [Export Mode](/docs/tutorial/encoding).

**Parameters:**
- `json` - JSON string or object containing updates

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const jsonStr = '{"ops": [], "peer": "1"}';
doc.importJsonUpdates(jsonStr);
```
</Indent>

### Version Control Methods

<Method>
```typescript
checkout(frontiers: Frontiers): void
```
</Method>
<Indent>
Checks out the document to a specific version, making it read-only at that point in history. This is the core of time travel; see [Time Travel](/docs/tutorial/time_travel) and [Version](/docs/tutorial/version).

**Parameters:**
- `frontiers` - Array of OpIds representing the target version

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const frontiers = doc.frontiers();
// Make some changes...
doc.checkout(frontiers); // Go back to previous version
```
</Indent>

<Method>
```typescript
checkoutToLatest(): void
```
</Method>
<Indent>
Returns the document to the latest version after a checkout. Related concepts: [Frontiers](/docs/concepts/frontiers) and [Version Vector](/docs/concepts/version_vector).

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.checkoutToLatest();
```
</Indent>

<Method>
```typescript
attach(): void
```
</Method>
<Indent>
Attaches the document to track latest changes after being detached. See [Attached vs Detached States](/docs/concepts/attached_detached) for how Loro separates current state from history.

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.attach();
```
</Indent>

<Method>
```typescript
detach(): void
```
</Method>
<Indent>
Detaches the document from tracking latest changes, freezing it at current version. See [Attached vs Detached States](/docs/concepts/attached_detached).

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.detach();
```
</Indent>

<Method>
```typescript
fork(): LoroDoc
```
</Method>
<Indent>
Creates a new document that is a fork of the current one with a new peer ID. Forking is useful for branching workflows; see [Version](/docs/tutorial/version).

**Returns:** A new LoroDoc instance

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const forkedDoc = doc.fork();
```
</Indent>

<Method>
```typescript
forkAt(frontiers: Frontiers): LoroDoc
```
</Method>
<Indent>
Creates a fork at a specific version in history. Learn more about versions, DAG history, and heads in [Version Deep Dive](/docs/advanced/version_deep_dive).

**Parameters:**
- `frontiers` - The version to fork from

**Returns:** A new LoroDoc instance

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const frontiers = doc.frontiers();
const forkedDoc = doc.forkAt(frontiers);
```
</Indent>

### Subscription Methods

<Method>
```typescript
subscribe(listener: (event: LoroEventBatch) => void): () => void
```
</Method>
<Indent>
Subscribes to all document changes. See [Event Handling](/docs/tutorial/event) for the event model and best practices.

**Parameters:**
- `listener` - Callback function that receives change events

**Returns:** Unsubscribe function

**Event Structure:**
```typescript
interface LoroEventBatch {
  by: "local" | "import" | "checkout"
  origin?: string
  currentTarget?: ContainerID
  events: LoroEvent[]
  from: Frontiers
  to: Frontiers
}
```

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const unsubscribe = doc.subscribe((event) => {
  console.log("Change type:", event.by);
  event.events.forEach(e => {
    console.log("Container changed:", e.target);
    console.log("Diff:", e.diff);
  });
});

// Later: unsubscribe();
```
</Indent>

<Method>
```typescript
subscribeLocalUpdates(f: (bytes: Uint8Array) => void): () => void
```
</Method>
<Indent>
Subscribes only to local changes, useful for syncing with remote peers. This is typically wired to your transport layer; see [Sync](/docs/tutorial/sync).

**Parameters:**
- `f` - Callback that receives binary updates

**Returns:** Unsubscribe function

**Example:**
```ts no_run twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
declare const websocket: { send: (data: Uint8Array) => void };
// ---cut---
const unsubscribe = doc.subscribeLocalUpdates((updates) => {
  // Send updates to remote peers
  websocket.send(updates);
});
```
</Indent>

<Method>
```typescript
subscribeFirstCommitFromPeer(f: (e: { peer: PeerID }) => void): () => void
```
</Method>
<Indent>
Subscribes to the first commit from each peer, useful for tracking peer metadata.

**Parameters:**
- `f` - Callback that receives peer information

**Returns:** Unsubscribe function

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.subscribeFirstCommitFromPeer(({ peer }) => {
  // Store peer metadata
  doc.getMap("peers").set(peer, {
    joinedAt: Date.now(),
    name: `User ${peer}`
  });
});
```
</Indent>

### Transaction Methods

<Method>
```typescript
commit(options?: { origin?: string, message?: string, timestamp?: number }): void
```
</Method>
<Indent>
Commits pending changes as a single transaction. A transaction groups operations into a Change; see [Operations and Changes](/docs/concepts/operations_changes). You can tag commits with origin and message for debugging; timestamps are Unix seconds (see [Storing Timestamps](/docs/advanced/timestamp)).

Note: Loro transactions are not ACID database transactions. They bundle local operations for event batching and history grouping; there is no rollback or isolation guarantee like a DB transaction. See [Transaction Model](/docs/concepts/transaction_model).

**Parameters:**
- `options` - Optional commit configuration
  - `origin` - Origin identifier for the commit
  - `message` - Commit message
  - `timestamp` - Unix timestamp in seconds

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.commit({
  origin: "user-action",
  message: "Updated document title",
  timestamp: Math.floor(Date.now() / 1000)
});
```
</Indent>

### Query Methods

<Method>
```typescript
toJSON(): Value
```
</Method>
<Indent>
Converts the entire document to a JSON-compatible value. If you prefer a structure where sub-containers are referenced by ID (for privacy or streaming), use getShallowValue(); see [Shallow Snapshots](/docs/concepts/shallow_snapshots).

**Returns:** JSON representation of the document

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const json = doc.toJSON();
console.log(JSON.stringify(json, null, 2));
```
</Indent>

<Method>
```typescript
getShallowValue(): Record<string, ContainerID>
```
</Method>
<Indent>
Gets a shallow representation where sub-containers are represented by their IDs. This is helpful when you want to share structure without history; see [Shallow Snapshots](/docs/concepts/shallow_snapshots).

**Returns:** Shallow JSON value

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const shallow = doc.getShallowValue();
// Sub-containers appear as: "cid:..."
```
</Indent>

<Method>
```typescript
version(): VersionVector
```
</Method>
<Indent>
Gets the current version vector of the document. Version vectors track how much data from each peer you’ve seen; see [Version Vector](/docs/concepts/version_vector).

**Returns:** Map from PeerID to counter

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const vv = doc.version();
console.log(vv.toJSON());
```
</Indent>

<Method>
```typescript
frontiers(): Frontiers
```
</Method>
<Indent>
Gets the current frontiers (heads) of the document. Frontiers are a compact representation of a version; see [Frontiers](/docs/concepts/frontiers) for when to use them instead of version vectors.

Note: Frontiers are compact version representation. For trade-offs versus Version Vectors and when to use each, see [Frontiers](/docs/concepts/frontiers).

**Returns:** Array of OpIds

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const frontiers = doc.frontiers();
// Can be used for checkouts or shallow snapshots
```
</Indent>

<Method>
```typescript
diff(from: Frontiers, to: Frontiers, for_json?: boolean): [ContainerID, Diff | JsonDiff][]
```
</Method>
<Indent>
Calculates differences between two versions. Understanding how Loro computes diffs benefits from the history DAG model; see [Version Deep Dive](/docs/advanced/version_deep_dive).

**Parameters:**
- `from` - Starting frontiers
- `to` - Ending frontiers  
- `for_json` - If true, returns JsonDiff format (default: true)

**Returns:** Array of container IDs and their diffs

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const fromFrontiers = doc.frontiers();
// Make changes...
const toFrontiers = doc.frontiers();

const diffs = doc.diff(fromFrontiers, toFrontiers);
diffs.forEach(([containerId, diff]) => {
  console.log(`Container ${containerId} changed:`, diff);
});
```
</Indent>

### Pre-Commit Hook

<Method>
```typescript
subscribePreCommit(f: (e: { changeMeta: Change, origin: string, modifier: ChangeModifier }) => void): () => void
```
</Method>
<Indent>
Subscribe to the pre-commit event. You can modify the message and timestamp of the next change. This hook runs right before a Change is recorded; see [Transaction Model](/docs/concepts/transaction_model) and [Operations and Changes](/docs/concepts/operations_changes).

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const unsubscribe = doc.subscribePreCommit(({ modifier }) => {
  modifier
    .setMessage("Tagged by pre-commit")
    .setTimestamp(Math.floor(Date.now() / 1000));
});
doc.getText("text").insert(0, "Hello");
doc.commit();
unsubscribe();
```
</Indent>

### Cursor Utilities

<Method>
```typescript
getCursorPos(cursor: Cursor): { update?: Cursor, offset: number, side: Side }
```
</Method>
<Indent>
Resolve a stable `Cursor` to an absolute position. Cursors remain valid across concurrent edits; see [Cursor and Stable Positions](/docs/concepts/cursor_stable_positions) and [Cursor tutorial](/docs/tutorial/cursor). The side controls affinity when the cursor sits at an insertion boundary.

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const text = doc.getText("text");
// ---cut---
text.insert(0, "abc");
const c0 = text.getCursor(1);
const pos = doc.getCursorPos(c0!);
console.log(pos.offset); // 1
```
</Indent>

### Pending Operations

<Method>
```typescript
getUncommittedOpsAsJson(): JsonSchema | undefined
```
</Method>
<Indent>
Get pending operations from the current transaction in JSON format. Useful for debugging what will be included in the next Change; see [Transaction Model](/docs/concepts/transaction_model).

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const text = doc.getText("text");
// ---cut---
text.insert(0, "Hello");
const pending = doc.getUncommittedOpsAsJson();
doc.commit();
const none = doc.getUncommittedOpsAsJson(); // undefined after commit
```
</Indent>

### Change Graph & History
These APIs traverse the history DAG of changes (ancestors/descendants, spans). If this sounds unfamiliar, start with Loro's [Versioning Deep Dive](/docs/advanced/version_deep_dive) and the [Event Graph Walker](/docs/concepts/event_graph_walker).

<Method>
```typescript
travelChangeAncestors(ids: OpId[], f: (change: Change) => boolean): void
```
</Method>
<Indent>
Visit ancestors of the given changes in causal order.

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.getText("text").insert(0, "Hello");
doc.commit();
const head = doc.frontiers();
doc.travelChangeAncestors(head, (change) => {
  console.log(change.peer, change.counter);
  return true; // continue
});
```
</Indent>

<Method>
```typescript
findIdSpansBetween(from: Frontiers, to: Frontiers): VersionVectorDiff
```
</Method>
<Indent>
Find the op id spans that lie between two versions.
</Indent>

<Method>
```typescript
exportJsonInIdSpan(idSpan: { peer: PeerID, counter: number, length: number }): JsonChange[]
```
</Method>
<Indent>
```ts twoslash
import { LoroDoc } from "loro-crdt";
const a = new LoroDoc();
const b = new LoroDoc();
// ---cut---
a.getText("text").update("Hello");
a.commit();
const snapshot = a.export({ mode: "snapshot" });
let printed: any;
b.subscribe((e) => {
  const spans = b.findIdSpansBetween(e.from, e.to);
  const changes = b.exportJsonInIdSpan(spans.forward[0]);
  printed = changes;
});
b.import(snapshot);
```
</Indent>

<Method>
```typescript
getChangedContainersIn(id: OpId, len: number): ContainerID[]
```
</Method>
<Indent>
Get container IDs modified in the given ID range.

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.getList("list").insert(0, 1);
doc.commit();
const head = doc.frontiers()[0];
const containers = doc.getChangedContainersIn(head, 1);
```
</Indent>

### Revert & Apply Diff

<Method>
```typescript
revertTo(frontiers: Frontiers): void
```
</Method>
<Indent>
Revert the document to a given version by generating inverse operations.

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.setPeerId("1");
const t = doc.getText("text");
t.update("Hello");
doc.commit();
doc.revertTo([{ peer: "1", counter: 1 }]);
```
</Indent>

<Method>
```typescript
applyDiff(diff: [ContainerID, Diff | JsonDiff][]): void
```
</Method>
<Indent>
Apply a batch of diffs to the document.

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc1 = new LoroDoc();
const doc2 = new LoroDoc();
// ---cut---
doc1.getText("text").insert(0, "Hello");
const diff = doc1.diff([], doc1.frontiers());
doc2.applyDiff(diff);
```
</Indent>

### Detached Editing

<Method>
```typescript
setDetachedEditing(enable: boolean): void
```
</Method>
<Indent>
Enables or disables detached editing mode. Detached editing lets you stage edits separate from the latest head; see [Attached vs Detached States](/docs/concepts/attached_detached).

**Parameters:**
- `enable` - Whether to enable detached editing

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.setDetachedEditing(true);
```
</Indent>

<Method>
```typescript
isDetachedEditingEnabled(): boolean
```
</Method>
<Indent>
Checks if detached editing mode is enabled.

**Returns:** True if detached editing is enabled

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const enabled = doc.isDetachedEditingEnabled();
```
</Indent>

<Method>
```typescript
isDetached(): boolean
```
</Method>
<Indent>
Checks if the document is currently detached.

**Returns:** True if document is detached

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
console.log(doc.isDetached());
```
</Indent>

### Commit Options Helpers

<Method>
```typescript
setNextCommitMessage(msg: string): void
```
</Method>
<Indent>
Sets the message for the next commit.

**Parameters:**
- `msg` - Commit message

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.setNextCommitMessage("User action");
```
</Indent>

<Method>
```typescript
setNextCommitOrigin(origin: string): void
```
</Method>
<Indent>
Sets the origin for the next commit.

**Parameters:**
- `origin` - Origin identifier

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.setNextCommitOrigin("ui");
```
</Indent>

<Method>
```typescript
setNextCommitTimestamp(timestamp: number): void
```
</Method>
<Indent>
Sets the timestamp for the next commit.

**Parameters:**
- `timestamp` - Unix timestamp in seconds

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.setNextCommitTimestamp(Math.floor(Date.now() / 1000));
```
</Indent>

<Method>
```typescript
setNextCommitOptions(options: { origin?: string, timestamp?: number, message?: string }): void
```
</Method>
<Indent>
Sets multiple options for the next commit.

**Parameters:**
- `options` - Commit options object

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.setNextCommitOptions({ origin: "ui", message: "batch" });
doc.getText("text").insert(0, "Hi");
doc.commit();
```
</Indent>

<Method>
```typescript
clearNextCommitOptions(): void
```
</Method>
<Indent>
Clears all pending commit options.

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.clearNextCommitOptions();
```
</Indent>

### Version & Frontier Utilities

<Method>
```typescript
frontiersToVV(frontiers: Frontiers): VersionVector
```
</Method>
<Indent>
Converts frontiers to a version vector.

**Parameters:**
- `frontiers` - Frontiers to convert

**Returns:** Version vector representation

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const frontiers = doc.frontiers();
const vv = doc.frontiersToVV(frontiers);
```
</Indent>

<Method>
```typescript
vvToFrontiers(vv: VersionVector): Frontiers
```
</Method>
<Indent>
Converts a version vector to frontiers.

**Parameters:**
- `vv` - Version vector to convert

**Returns:** Frontiers representation

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const vv = doc.version();
const frontiers = doc.vvToFrontiers(vv);
```
</Indent>

<Method>
```typescript
oplogVersion(): VersionVector
```
</Method>
<Indent>
Gets the oplog version vector.

**Returns:** Oplog version vector

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const vv = doc.oplogVersion();
```
</Indent>

<Method>
```typescript
oplogFrontiers(): Frontiers
```
</Method>
<Indent>
Gets the oplog frontiers.

**Returns:** Oplog frontiers

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const frontiers = doc.oplogFrontiers();
```
</Indent>

<Method>
```typescript
cmpWithFrontiers(frontiers: Frontiers): -1 | 0 | 1
```
</Method>
<Indent>
Compares current document state with given frontiers.

**Parameters:**
- `frontiers` - Frontiers to compare with

**Returns:** -1 if behind, 0 if equal, 1 if ahead

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const frontiers = doc.frontiers();
const cmp = doc.cmpWithFrontiers(frontiers);
```
</Indent>

<Method>
```typescript
cmpFrontiers(a: Frontiers, b: Frontiers): -1 | 0 | 1 | undefined
```
</Method>
<Indent>
Compares two frontiers.

**Parameters:**
- `a` - First frontiers
- `b` - Second frontiers

**Returns:** -1 if a < b, 0 if equal, 1 if a > b, undefined if incomparable

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const f1 = doc.frontiers();
const f2 = doc.frontiers();
const cmp = doc.cmpFrontiers(f1, f2);
```
</Indent>

### JSONPath & Path Queries
Use simple path strings and JSONPath to fetch nested values and containers. Paths are formed from root container names and keys (e.g., map/key or list/0). For container IDs, see [Container ID](/docs/advanced/cid).

<Method>
```typescript
getByPath(path: string): Value | Container | undefined
```
</Method>
<Indent>
Gets a value or container by its path.

**Parameters:**
- `path` - Path string (e.g., "map/key")

**Returns:** Value or container at the path, or undefined

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
map.set("key", 1);
// ---cut---
const value = doc.getByPath("map/key");
```
</Indent>

<Method>
```typescript
getPathToContainer(id: ContainerID): (string | number)[] | undefined
```
</Method>
<Indent>
Gets the path to a container by its ID.

**Parameters:**
- `id` - Container ID

**Returns:** Array representing the path, or undefined

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
const path = doc.getPathToContainer(map.id);
```
</Indent>

<Method>
```typescript
JSONPath(jsonpath: string): any[]
```
</Method>
<Indent>
Queries the document using JSONPath syntax.

**Parameters:**
- `jsonpath` - JSONPath query string

**Returns:** Array of matching values

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
map.set("key", 1);
// ---cut---
const results = doc.JSONPath("$.map");
```
</Indent>

### Shallow Doc Utilities
These helpers relate to shallow snapshots and redaction. If you need a refresher on what “shallow” means, see [Shallow Snapshots](/docs/concepts/shallow_snapshots).

<Method>
```typescript
shallowSinceVV(): VersionVector
```
</Method>
<Indent>
Gets the version vector since which the document is shallow.

**Returns:** Version vector

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const vv = doc.shallowSinceVV();
```
</Indent>

<Method>
```typescript
shallowSinceFrontiers(): Frontiers
```
</Method>
<Indent>
Gets the frontiers since which the document is shallow.

**Returns:** Frontiers

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const frontiers = doc.shallowSinceFrontiers();
```
</Indent>

<Method>
```typescript
isShallow(): boolean
```
</Method>
<Indent>
Checks if the document is shallow.

**Returns:** True if document is shallow

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const shallow = doc.isShallow();
```
</Indent>

<Method>
```typescript
setHideEmptyRootContainers(hide: boolean): void
```
</Method>
<Indent>
Controls whether empty root containers are hidden in JSON output.

**Parameters:**
- `hide` - Whether to hide empty root containers

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.setHideEmptyRootContainers(true);
// Now empty roots are hidden in toJSON()
```
</Indent>

<Method>
```typescript
deleteRootContainer(cid: ContainerID): void
```
</Method>
<Indent>
Deletes a root container.

**Parameters:**
- `cid` - Container ID to delete

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
doc.deleteRootContainer(map.id);
```
</Indent>

<Method>
```typescript
hasContainer(id: ContainerID): boolean
```
</Method>
<Indent>
Checks if a container exists in the document.

**Parameters:**
- `id` - Container ID to check

**Returns:** True if container exists

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
const exists = doc.hasContainer(map.id);
```
</Indent>

### JSON Serialization with Replacer

<Method>
```typescript
toJsonWithReplacer(replacer: (key: string | number, value: Value | Container) => Value | Container | undefined): Value
```
</Method>
<Indent>
Customize JSON serialization of containers and values.

**Parameters:**
- `replacer` - Function to transform values during serialization

**Returns:** Customized JSON value

**Example:**
```ts twoslash
import { LoroDoc, LoroText } from "loro-crdt";
const doc = new LoroDoc();
const text = doc.getText("text");
text.insert(0, "Hello");
// ---cut---
const json = doc.toJsonWithReplacer((key, value) => {
  if (value instanceof LoroText) {
    return value.toDelta();
  }
  return value;
});
```
</Indent>

### Stats & Introspection

<Method>
```typescript
debugHistory(): void
```
</Method>
<Indent>
Prints debug information about the document history.

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.debugHistory();
```
</Indent>

<Method>
```typescript
changeCount(): number
```
</Method>
<Indent>
Gets the total number of changes in the document.

**Returns:** Number of changes

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const changes = doc.changeCount();
```
</Indent>

<Method>
```typescript
opCount(): number
```
</Method>
<Indent>
Gets the total number of operations in the document.

**Returns:** Number of operations

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const ops = doc.opCount();
```
</Indent>

<Method>
```typescript
getAllChanges(): Map<PeerID, Change[]>
```
</Method>
<Indent>
Gets all changes grouped by peer ID.

**Returns:** Map of peer ID to changes

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const changes = doc.getAllChanges();
```
</Indent>

<Method>
```typescript
getChangeAt(id: OpId): Change
```
</Method>
<Indent>
Gets a specific change by operation ID.

**Parameters:**
- `id` - Operation ID

**Returns:** Change object

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const frontiers = doc.frontiers();
const change = doc.getChangeAt(frontiers[0]);
```
</Indent>

<Method>
```typescript
getChangeAtLamport(peer_id: string, lamport: number): Change | undefined
```
</Method>
<Indent>
Gets a change by peer ID and Lamport timestamp.

**Parameters:**
- `peer_id` - Peer ID
- `lamport` - Lamport timestamp

**Returns:** Change object or undefined

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const change = doc.getChangeAtLamport(doc.peerIdStr, 0);
```
</Indent>

<Method>
```typescript
getOpsInChange(id: OpId): any[]
```
</Method>
<Indent>
Gets all operations in a specific change.

**Parameters:**
- `id` - Operation ID

**Returns:** Array of operations

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const frontiers = doc.frontiers();
const ops = doc.getOpsInChange(frontiers[0]);
```
</Indent>

<Method>
```typescript
getPendingTxnLength(): number
```
</Method>
<Indent>
Gets the number of pending operations in the current transaction.

**Returns:** Number of pending operations

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
doc.getText("text").insert(0, "x");
console.log(doc.getPendingTxnLength());
doc.commit();
```
</Indent>

### Import/Export Utilities

<Method>
```typescript
decodeImportBlobMeta(blob: Uint8Array, check_checksum: boolean): ImportBlobMetadata
```
</Method>
<Indent>
Decodes metadata from an import blob.

**Parameters:**
- `blob` - Binary data to decode
- `check_checksum` - Whether to verify checksum

**Returns:** Import blob metadata

**Example:**
```ts twoslash
import { LoroDoc, decodeImportBlobMeta } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const updates = doc.export({ mode: "update" });
const meta = decodeImportBlobMeta(updates, true);
```
</Indent>

<Method>
```typescript
redactJsonUpdates(json: string | JsonSchema, version_range: any): JsonSchema
```
</Method>
<Indent>
Redacts JSON updates within a specified version range.

**Parameters:**
- `json` - JSON updates to redact
- `version_range` - Version range for redaction

**Returns:** Redacted JSON schema

**Example:**
```ts twoslash
import { LoroDoc, redactJsonUpdates } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
const json = doc.exportJsonUpdates();
const redacted = redactJsonUpdates(json, { [doc.peerIdStr]: [0, 999999] });
```
</Indent>

---

## Container Types

### LoroText

A rich text container supporting collaborative text editing with formatting. Supports overlapping marks (bold, italic, links) and stable cursors. See [Text](/docs/tutorial/text) for concepts and editor integrations.


<Method>
```typescript
insert(index: number, text: string): void
```
</Method>

<Indent>
Inserts text at the specified position.

**Parameters:**
- `index` - Position to insert at (0-based)
- `text` - Text to insert

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const text = doc.getText("text");
// ---cut---
text.insert(0, "Hello ");
text.insert(6, "World");
```
</Indent>

<Method>
```typescript
delete(index: number, len: number): void
```
</Method>

<Indent>
Deletes text from the specified position.

**Parameters:**
- `index` - Starting position
- `len` - Number of characters to delete

**Example:**
```typescript
text.delete(5, 1); // Delete one character at position 5
```
</Indent>

<Method>
```typescript
mark(range: { start: number, end: number }, key: string, value: Value): void
```
</Method>

<Indent>
Applies formatting to a text range. Marks can be configured to expand/stop at edges via configTextStyle(); see [Text](/docs/tutorial/text) for mark behavior.

**Parameters:**
- `range` - The range to format
- `key` - Style attribute name
- `value` - Style value

**Example:**
```typescript
text.mark({ start: 0, end: 5 }, "bold", true);
text.mark({ start: 6, end: 11 }, "color", "#ff0000");
```
</Indent>

<Method>
```typescript
unmark(range: { start: number, end: number }, key: string): void
```
</Method>
<Indent>
Removes formatting from a text range. For how conflicting edits on marks resolve, see [Text](/docs/tutorial/text).

**Parameters:**
- `range` - The range to unformat
- `key` - Style attribute to remove

**Example:**
```typescript
text.unmark({ start: 0, end: 5 }, "bold");
```
</Indent>

<Method>
```typescript
toDelta(): Delta<string>[]
```
</Method>
<Indent>
Converts text to Delta format (Quill-compatible).

**Returns:** Array of Delta operations

**Example:**
```typescript
const delta = text.toDelta();
// [{ insert: "Hello", attributes: { bold: true } }, { insert: " World" }]
```
</Indent>

<Method>
```typescript
applyDelta(delta: Delta<string>[]): void
```
</Method>
<Indent>
Applies Delta operations to the text.

**Parameters:**
- `delta` - Array of Delta operations

**Example:**
```typescript
text.applyDelta([
  { insert: "Hello", attributes: { bold: true } },
  { insert: " World" }
]);
```
</Indent>

<Method>
```typescript
update(text: string, options?: { timeoutMs?: number; useRefinedDiff?: boolean }): void
```
</Method>
<Indent>
Updates the current text to the target text using Myers' diff algorithm.

**Parameters:**
- `text` - New text content
- `options` - Update options
  - `timeoutMs` - Optional timeout for the diff computation
  - `useRefinedDiff` - Use refined diff for better quality on long texts

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const text = doc.getText("text");
// ---cut---
text.insert(0, "Hello");
text.update("Hello World", { timeoutMs: 100 });
```
</Indent>

<Method>
```typescript
updateByLine(text: string, options?: { timeoutMs?: number; useRefinedDiff?: boolean }): void
```
</Method>
<Indent>
Line-based update that's faster for large texts (less precise than `update`).

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const text = doc.getText("text");
// ---cut---
text.insert(0, "Line A\nLine C");
text.updateByLine("Line A\nLine B\nLine C");
```
</Indent>

<Method>
```typescript
getCursor(pos: number, side?: Side): Cursor | undefined
```
</Method>
<Indent>
Gets a stable cursor position that survives edits.

**Parameters:**
- `pos` - Position in the text
- `side` - Cursor affinity (-1, 0, or 1)

**Returns:** Cursor object or undefined

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const text = doc.getText("text");
// ---cut---
const cursor = text.getCursor(5);
// Cursor remains valid even after edits
```
</Indent>

<Method>
```typescript
toString(): string
```
</Method>
<Indent>
Converts to plain text string.

**Returns:** Plain text content

**Example:**
```typescript
const plainText = text.toString();
```
</Indent>

### LoroList

An ordered list container for collaborative arrays. See [List and Movable List](/docs/tutorial/list) and [Choosing CRDT Types](/docs/concepts/choose_crdt_type).

<Method>
```typescript
insert(pos: number, value: Value | Container): void
```
</Method>
<Indent>
Inserts a value at the specified position.

**Parameters:**
- `pos` - Insert position
- `value` - Value to insert

**Example:**
```typescript
list.insert(0, "First");
list.insert(1, { type: "object" });
```
</Indent>

<Method>
```typescript
insertContainer<T extends Container>(pos: number, container: T): T
```
</Method>
<Indent>
Inserts a new container at the position.

**Parameters:**
- `pos` - Insert position  
- `container` - Container instance

**Returns:** The inserted container

**Example:**
```typescript
const subText = list.insertContainer(0, new LoroText());
subText.insert(0, "Nested text");
```
</Indent>

<Method>
```typescript
delete(pos: number, len: number): void
```
</Method>
<Indent>
Deletes elements from the list.

**Parameters:**
- `pos` - Starting position
- `len` - Number of elements to delete

**Example:**
```typescript
list.delete(1, 2); // Delete 2 elements starting at index 1
```
</Indent>

<Method>
```typescript
push(value: Value | Container): void
```
</Method>
<Indent>
Appends a value to the end of the list.

**Parameters:**
- `value` - Value to append

**Example:**
```typescript
list.push("Last item");
```
</Indent>

<Method>
```typescript
getIdAt(pos: number): { peer: PeerID, counter: number } | undefined
```
</Method>
<Indent>
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const list = doc.getList("list");
// ---cut---
list.insert(0, 1);
const id0 = list.getIdAt(0);
```
</Indent>

<Method>
```typescript
pushContainer<T extends Container>(container: T): T
```
</Method>
<Indent>
Appends a container to the end of the list.

**Parameters:**
- `container` - Container to append

**Returns:** The appended container

**Example:**
```typescript
const map = list.pushContainer(new LoroMap());
map.set("key", "value");
```
</Indent>

<Method>
```typescript
pop(): Value | Container | undefined
```
</Method>
<Indent>
Removes and returns the last element.

**Returns:** The removed element or undefined

**Example:**
```ts no_run twoslash
import { LoroList } from "loro-crdt";
declare const list: LoroList;
// ---cut---
const lastItem = list.pop();
```
</Indent>

<Method>
```typescript
get(index: number): Value | Container | undefined
```
</Method>
<Indent>
Gets the value at the specified index.

**Parameters:**
- `index` - Element index

**Returns:** The value or undefined

**Example:**
```ts no_run twoslash
import { LoroList } from "loro-crdt";
declare const list: LoroList;
// ---cut---
const item = list.get(0);
```
</Indent>

<Method>
```typescript
getCursor(pos: number, side?: Side): Cursor | undefined
```
</Method>
<Indent>
Gets a stable cursor for the position.

**Parameters:**
- `pos` - Position in the list
- `side` - Cursor affinity

**Returns:** Cursor object or undefined

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const list = doc.getList("list");
// ---cut---
const cursor = list.getCursor(2);
```
</Indent>

<Method>
```typescript
toArray(): (Value | Container)[]
```
</Method>
<Indent>
Converts the list to a JavaScript array.

**Returns:** Array of values

**Example:**
```typescript
const array = list.toArray();
```
</Indent>

<Method>
```typescript
clear(): void
```
</Method>
<Indent>
Removes all elements from the list.

**Example:**
```typescript
list.clear();
```
</Indent>

<Method>
```typescript
length: number
```
</Method>
<Indent>
Gets the number of elements in the list.

**Returns:** List length

**Example:**
```typescript
console.log(`List has ${list.length} items`);
```
</Indent>

### LoroMap

A key-value map container for collaborative objects. See [Map](/docs/tutorial/map).

<Method>
```typescript
set(key: string, value: Value | Container): void
```
</Method>
<Indent>
Sets a key-value pair.

**Parameters:**
- `key` - The key
- `value` - The value

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
map.set("name", "Alice");
map.set("age", 30);
```
</Indent>

<Method>
```typescript
setContainer<T extends Container>(key: string, container: T): T
```
</Method>
<Indent>
Sets a container as the value for a key.

**Parameters:**
- `key` - The key
- `container` - Container instance

**Returns:** The set container

**Example:**
```ts twoslash
import { LoroDoc, LoroList } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
const list = map.setContainer("items", new LoroList());
list.push("item1");
```
</Indent>

<Method>
```typescript
get(key: string): Value | Container | undefined
```
</Method>
<Indent>
Gets the value for a key.

**Parameters:**
- `key` - The key

**Returns:** The value or undefined

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
const name = map.get("name");
```
</Indent>

<Method>
```typescript
getOrCreateContainer<T extends Container>(key: string, container: T): T
```
</Method>
<Indent>
Gets an existing container or creates a new one.

**Parameters:**
- `key` - The key
- `container` - Container to create if not exists

**Returns:** The container

**Example:**
```ts twoslash
import { LoroDoc, LoroText } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
const text = map.getOrCreateContainer("description", new LoroText());
```
</Indent>

<Method>
```typescript
delete(key: string): void
```
</Method>
<Indent>
Removes a key-value pair.

**Parameters:**
- `key` - The key to remove

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
map.delete("obsoleteKey");
```
</Indent>

<Method>
```typescript
clear(): void
```
</Method>
<Indent>
Removes all key-value pairs.

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
map.clear();
```
</Indent>

<Method>
```typescript
keys(): string[]
```
</Method>
<Indent>
Gets all keys in the map.

**Returns:** Array of keys

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
const allKeys = map.keys();
```
</Indent>

<Method>
```typescript
values(): (Value | Container)[]
```
</Method>
<Indent>
Gets all values in the map.

**Returns:** Array of values

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
const allValues = map.values();
```
</Indent>

<Method>
```typescript
entries(): [string, Value | Container][]
```
</Method>
<Indent>
Gets all key-value pairs.

**Returns:** Array of entries

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
for (const [key, value] of map.entries()) {
  console.log(`${key}: ${value}`);
}
```
</Indent>

<Method>
```typescript
getLastEditor(key: string): PeerID | undefined
```
</Method>
<Indent>
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
map.set("k", 1);
doc.commit();
const who = map.getLastEditor("k");
```
</Indent>

<Method>
```typescript
size: number
```
</Method>
<Indent>
Gets the number of key-value pairs.

**Returns:** Map size

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
console.log(`Map has ${map.size} entries`);
```
</Indent>

### LoroTree

A hierarchical tree container for nested structures. Supports moving subtrees while handling concurrent edits. See [Tree](/docs/tutorial/tree).

<Method>
```typescript
createNode(parent?: TreeID, index?: number): LoroTreeNode
```
</Method>
<Indent>
Creates a new tree node.

**Parameters:**
- `parent` - Parent node ID (optional, creates root if omitted)
- `index` - Position among siblings (optional)

**Returns:** The new node's handler

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
// ---cut---
const root = tree.createNode();
const child = root.createNode(0);
```
</Indent>

<Method>
```typescript
move(target: TreeID, parent?: TreeID, index?: number): void
```
</Method>
<Indent>
Moves a node to a new position.

**Parameters:**
- `target` - Node to move
- `parent` - New parent (undefined for root)
- `index` - Position among siblings

**Example:**
```ts twoslash
import { LoroDoc, TreeID } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
declare const nodeId: TreeID;
declare const newParentId: TreeID;
// ---cut---
tree.move(nodeId, newParentId, 0);
```
</Indent>

<Method>
```typescript
delete(target: TreeID): void
```
</Method>
<Indent>
Deletes a node and its descendants.

**Parameters:**
- `target` - Node to delete

**Example:**
```ts twoslash
import { LoroDoc, TreeID } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
declare const nodeId: TreeID;
// ---cut---
tree.delete(nodeId);
```
</Indent>

<Method>
```typescript
getNodeByID(id: TreeID): LoroTreeNode | undefined
```
</Method>
<Indent>
Gets a node handler by its ID.

**Parameters:**
- `id` - Node ID

**Returns:** Node handler or undefined

**Example:**
```ts twoslash
import { LoroDoc, TreeID } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
declare const nodeId: TreeID;
// ---cut---
const node = tree.getNodeByID(nodeId);
if (node) {
  node.data.set("label", "New Label");
}
```
</Indent>

<Method>
```typescript
nodes(): LoroTreeNode[]
```
</Method>
<Indent>
Gets all nodes in the tree.

**Returns:** Array of all nodes

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
// ---cut---
const allNodes = tree.nodes();
```
</Indent>

<Method>
```typescript
roots(): LoroTreeNode[]
```
</Method>
<Indent>
Gets all root nodes.

**Returns:** Array of root nodes

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
// ---cut---
const rootNodes = tree.roots();
```
</Indent>

<Method>
```typescript
has(target: TreeID): boolean
```
</Method>
<Indent>  
Checks if a node exists.

**Parameters:**
- `target` - Node ID to check

**Returns:** Boolean indicating existence

**Example:**
```ts twoslash
import { LoroDoc, TreeID } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
declare const nodeId: TreeID;
// ---cut---
if (tree.has(nodeId)) {
  console.log("Node exists");
}
```
</Indent>

<Method>
```typescript
isNodeDeleted(target: TreeID): boolean
```
</Method>
<Indent>
Checks if a node has been deleted.

**Parameters:**
- `target` - Node ID to check

**Returns:** Boolean indicating deletion status

**Example:**
```ts twoslash
import { LoroDoc, TreeID } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
declare const nodeId: TreeID;
// ---cut---
if (tree.isNodeDeleted(nodeId)) {
  console.log("Node was deleted");
}
```
</Indent>
### LoroTreeNode

Represents a single node in the tree.

<Method>
```typescript
data: LoroMap
```
</Method>
<Indent>
A map container for storing node metadata.

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const node = tree.createNode();
node.data.set("title", "Node Title");
node.data.set("expanded", true);
```
</Indent>

<Method>
```typescript
createNode(index?: number): LoroTreeNode
```
</Method>
<Indent>
Creates a child node.

**Parameters:**
- `index` - Position among siblings

**Returns:** New node's handler

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const node = tree.createNode();
const childId = node.createNode(0);
```
</Indent>

<Method>
```typescript
move(parent?: LoroTreeNode, index?: number): void
```
</Method>
<Indent>
Moves this node to a new parent.

**Parameters:**
- `parent` - New parent node
- `index` - Position among siblings

**Example:**
```ts twoslash
import { LoroDoc, LoroTreeNode } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const node = tree.createNode();
const parent = tree.createNode();
// ---cut---
node.move(parent, 0);
```
</Indent>

<Method>
```typescript
moveAfter(target: LoroTreeNode): void
```
</Method>
<Indent>
Moves this node after a sibling.

**Parameters:**
- `target` - Sibling node

**Example:**
```ts twoslash
import { LoroDoc, LoroTreeNode } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const node = tree.createNode();
const sibling = tree.createNode();
// ---cut---
node.moveAfter(sibling);
```
</Indent> 

<Method>
```typescript
moveBefore(target: LoroTreeNode): void
```
</Method>
<Indent>
Moves this node before a sibling.

**Parameters:**
- `target` - Sibling node

**Example:**
```ts twoslash
import { LoroDoc, LoroTreeNode } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const node = tree.createNode();
const sibling = tree.createNode();
// ---cut---
node.moveBefore(sibling);
```
</Indent>

<Method>
```typescript
parent(): LoroTreeNode | undefined
```
</Method>
<Indent>
Gets the parent node.

**Returns:** Parent node or undefined

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const node = tree.createNode();
// ---cut---
const parentNode = node.parent();
```
</Indent>

<Method>
```typescript
children(): LoroTreeNode[]
```
</Method>
<Indent>
Gets all child nodes.

**Returns:** Array of children

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const node = tree.createNode();
// ---cut---
const childNodes = node.children();
```
</Indent>

<Method>
```typescript
index(): number | undefined
```
</Method>
<Indent>
Gets the position among siblings.

**Returns:** Index or undefined if root

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const node = tree.createNode();
// ---cut---
const position = node.index();
```
</Indent>

<Method>
```typescript
fractionalIndex(): string | undefined
creationId(): { peer: PeerID, counter: number }
creator(): PeerID
getLastMoveId(): { peer: PeerID, counter: number } | undefined
```
</Method>
<Indent>
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const root = tree.createNode();
const node = root.createNode();
// ---cut---
const fi = node.fractionalIndex();
const create = node.creationId();
const author = node.creator();
const lastMove = node.getLastMoveId();
```
</Indent>

<Method>
```typescript
isDeleted(): boolean
```
</Method>
<Indent>  
Checks if this node has been deleted.

**Returns:** Boolean deletion status

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
const node = tree.createNode();
// ---cut---
if (node.isDeleted()) {
  console.log("Node is deleted");
}
```
</Indent>

### LoroCounter

A counter CRDT for collaborative numeric values.

<Method>
```typescript
increment(value: number): void
```
</Method>
<Indent>
Increments the counter.

**Parameters:**
- `value` - Amount to increment (default: 1)

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const counter = doc.getCounter("counter");
// ---cut---
counter.increment(5);   // +5
```
</Indent>

<Method>
```typescript
decrement(value: number): void
```
</Method>
<Indent>
Decrements the counter.

**Parameters:**
- `value` - Amount to decrement (default: 1)

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const counter = doc.getCounter("counter");
// ---cut---
counter.decrement(3);   // -3
```
</Indent>

<Method>
```typescript
value: number
```
</Method>
<Indent>
Gets the current counter value.

**Returns:** Current numeric value

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const counter = doc.getCounter("counter");
// ---cut---
console.log(`Counter value: ${counter.value}`);
```
</Indent>

### LoroMovableList

A list optimized for move operations. Designed for frequent reordering (drag-and-drop) with good behavior under concurrent moves. See [List and Movable List](/docs/tutorial/list).

Extends `LoroList` with additional methods for efficient element reordering.

<Method>
```typescript
move(from: number, to: number): void
```
</Method>
<Indent>
Moves an element from one position to another.

**Parameters:**
- `from` - Source index
- `to` - Target index

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const movableList = doc.getMovableList("list");
// ---cut---
movableList.move(0, 3); // Move first element to fourth position
```
</Indent>

<Method>
```typescript
set(pos: number, value: Value | Container): void
```
</Method>
<Indent>  
Replaces the value at a position.

**Parameters:**
- `pos` - Position to update
- `value` - New value

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const movableList = doc.getMovableList("list");
// ---cut---
movableList.set(0, "Updated value");
```
</Indent>

<Method>
```typescript
setContainer<T extends Container>(pos: number, container: T): T
```
</Method>
<Indent>  
Replaces the value with a container.

**Parameters:**
- `pos` - Position to update
- `container` - New container

**Returns:** The set container

**Example:**
```ts twoslash
import { LoroDoc, LoroText } from "loro-crdt";
const doc = new LoroDoc();
const movableList = doc.getMovableList("list");
// ---cut---
const text = movableList.setContainer(0, new LoroText());
```
</Indent> 

## Synchronization

### Import/Export Patterns

#### Basic Synchronization

```ts twoslash
import { LoroDoc } from "loro-crdt";
// ---cut---
// Peer A: Export updates
const doc1 = new LoroDoc();
doc1.getText("text").insert(0, "Hello");
const updates = doc1.export({ mode: "update" });

// Peer B: Import updates
const doc2 = new LoroDoc();
doc2.import(updates);
```

#### Continuous Sync

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc1 = new LoroDoc();
const doc2 = new LoroDoc();
// ---cut---
// Set up bidirectional sync
doc1.subscribeLocalUpdates((updates) => {
  doc2.import(updates);
});

doc2.subscribeLocalUpdates((updates) => {
  doc1.import(updates);
});
```

#### Network Sync with WebSocket

```ts no_run twoslash
import { LoroDoc } from "loro-crdt";
declare const ws: { 
  send: (data: Uint8Array) => void;
  on: (event: string, handler: (data: any) => void) => void;
};
// ---cut---
// Client side
const doc = new LoroDoc();

// Send local updates to server
doc.subscribeLocalUpdates((updates) => {
  ws.send(updates);
});

// Receive updates from server
ws.on('message', (data) => {
  doc.import(new Uint8Array(data));
});
```

### Shallow Snapshots

Shallow snapshots allow for efficient storage by garbage collecting deleted operations.

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
// Create shallow snapshot
const frontiers = doc.frontiers();
const shallowSnapshot = doc.export({
  mode: "shallow-snapshot",
  frontiers: frontiers
});

// Import shallow snapshot
const newDoc = new LoroDoc();
newDoc.import(shallowSnapshot);
```

---

## Version Control

### Time Travel

Navigate through document history:

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
// Save current version
const v1 = doc.frontiers();

// Make changes
doc.getText("text").insert(0, "New text");

// Save new version
const v2 = doc.frontiers();

// Travel back
doc.checkout(v1);
console.log(doc.getText("text").toString()); // Original text

// Travel forward
doc.checkout(v2);
console.log(doc.getText("text").toString()); // New text

// Return to latest
doc.checkoutToLatest();
```

### Forking

Create document branches:

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
// Fork at current state
const fork1 = doc.fork();
fork1.getText("text").insert(0, "Fork 1 changes");

// Fork at specific version
const historicalVersion = doc.frontiers();
const fork2 = doc.forkAt(historicalVersion);
fork2.getText("text").insert(0, "Fork 2 changes");

// Original document remains unchanged
```

### Version Vectors

Track document versions:

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const vv = doc.version();
console.log(`Document has ${vv.length()} peers`);
```

---

## Events & Subscriptions

### Event Structure

```typescript
interface LoroEventBatch {
  by: "local" | "import" | "checkout"
  origin?: string
  currentTarget?: ContainerID
  events: LoroEvent[]
  from: Frontiers
  to: Frontiers
}

interface LoroEvent {
  target: ContainerID
  diff: Diff
  path: Path
}
```

### Diff Types

Different containers produce different diff types:

<Method>
```typescript
type TextDiff = {
  type: "text"
  diff: Delta<string>[]
}
```
</Method>
<Indent>
Represents changes to text content using Delta format.

**Properties:**
- `type` - Always "text" for text diffs
- `diff` - Array of Delta operations (insert, delete, retain)

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const text = doc.getText("text");
// ---cut---
// Example
text.subscribe((e) => {
  for (const event of e.events) {
    if (event.diff.type === "text") {
      event.diff.diff.forEach(delta => {
        if (delta.insert) {
          console.log(`Inserted: "${delta.insert}"`);
        }
        if (delta.delete) {
          console.log(`Deleted ${delta.delete} characters`);
        }
      });
    }
  }
});
```
</Indent>

<Method>
```typescript
type ListDiff = {
  type: "list"
  diff: Delta<(Value | Container)[]>[]
}
```
</Method>
<Indent>
Represents changes to list content using Delta format.

**Properties:**
- `type` - Always "list" for list diffs
- `diff` - Array of Delta operations on list items

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const list = doc.getList("list");
// ---cut---
// Example
list.subscribe((e) => {
  for (const event of e.events) {
    if (event.diff.type === "list") {
      event.diff.diff.forEach(delta => {
        if (delta.insert) {
          console.log(`Inserted items:`, delta.insert);
        }
      });
    }
  }
});
```
</Indent>

<Method>
```typescript
type MapDiff = {
  type: "map"
  updated: Record<string, Value | Container | undefined>
}
```
</Method>
<Indent>
Represents changes to map content.

**Properties:**
- `type` - Always "map" for map diffs
- `updated` - Record of key-value changes (undefined means deleted)

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const map = doc.getMap("map");
// ---cut---
// Example
map.subscribe((e) => {
  for (const event of e.events) {
    if (event.diff.type === "map") {
      Object.entries(event.diff.updated).forEach(([key, value]) => {
        if (value === undefined) {
          console.log(`Deleted key: ${key}`);
        } else {
          console.log(`Updated key: ${key} = ${value}`);
        }
      });
    }
  }
});
```
</Indent>

<Method>
```typescript
type TreeDiff = {
  type: "tree"
  diff: TreeDiffItem[]
}

type TreeDiffItem =
  | {
      target: TreeID
      action: "create"
      parent: TreeID | undefined
      index: number
      fractionalIndex: string
    }
  | {
      target: TreeID
      action: "delete"
      oldParent: TreeID | undefined
      oldIndex: number
    }
  | {
      target: TreeID
      action: "move"
      parent: TreeID | undefined
      index: number
      fractionalIndex: string
      oldParent: TreeID | undefined
      oldIndex: number
    }
```
</Method>
<Indent>
Represents changes to tree structure.

**Properties:**
- `type` - Always "tree" for tree diffs
- `diff` - Array of TreeDiffItem operations (create, delete, move)

**TreeDiffItem Actions:**
- `create` - Node creation with parent and position
- `delete` - Node deletion with old parent and position
- `move` - Node movement with old and new positions

**Example:**
```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
const tree = doc.getTree("tree");
// ---cut---
// Example
tree.subscribe((e) => {
  for (const event of e.events) {
    if (event.diff.type === "tree") {
      event.diff.diff.forEach(item => {
        switch (item.action) {
          case "create":
            console.log(`Created node ${item.target}`);
            break;
          case "move":
            console.log(`Moved node ${item.target}`);
            break;
          case "delete":
            console.log(`Deleted node ${item.target}`);
            break;
        }
      });
    }
  }
});
```
</Indent>
```

### Deep Subscription

Subscribe to nested changes:

```ts twoslash
import { LoroDoc } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
// Subscribe to specific container
const text = doc.getText("text");
text.subscribe((event) => {
  console.log("Text changed:", event);
});

// Subscribe with deep observation
doc.subscribe((event) => {
  // Path shows the location of the change
  event.events.forEach(e => {
    console.log("Change path:", e.path);
    console.log("Container:", e.target);
    console.log("Diff:", e.diff);
  });
});
```

---

## Undo/Redo

Local undo operates on your own changes without breaking collaboration. See [Undo/Redo](/docs/advanced/undo) for design details and caveats in collaborative settings.

### UndoManager

Provides local undo/redo functionality:

```ts twoslash
import { LoroDoc, UndoManager } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
// Create undo manager
const undo = new UndoManager(doc, {
  mergeInterval: 1000,        // Merge changes within 1 second
  maxUndoSteps: 100,          // Maximum undo stack size
  excludeOriginPrefixes: ["sync-"],  // Ignore changes with these origins
});

// Perform undo/redo
if (undo.canUndo()) {
  undo.undo();
}

if (undo.canRedo()) {
  undo.redo();
}
```

### Grouping Operations

Group multiple operations into a single undo step:

```ts twoslash
import { LoroDoc, UndoManager } from "loro-crdt";
const doc = new LoroDoc();
const undo = new UndoManager(doc, {});
const text = doc.getText("text");
const map = doc.getMap("map");
// ---cut---
undo.groupStart();
text.insert(0, "Hello");
doc.commit();
map.set("key", "value");
doc.commit();
undo.groupEnd();

// All three operations will be undone together
undo.undo();
```

### Custom Undo Handlers

Handle cursor restoration and side effects:

```ts twoslash
import { LoroDoc, UndoManager } from "loro-crdt";
const doc = new LoroDoc();
declare function saveCursorPositions(): any;
declare function restoreCursorPositions(cursors: any): void;
// ---cut---
const undo = new UndoManager(doc, {
  onPush: (isUndo, counterRange, event) => {
    // Save cursor positions when adding to undo stack
    const cursors = saveCursorPositions();
    return {
      value: doc.toJSON(),
      cursors: cursors
    };
  },
  
  onPop: (isUndo, { value, cursors }, counterRange) => {
    // Restore cursor positions when undoing
    restoreCursorPositions(cursors);
  }
});
```

---

## Types & Interfaces

### Core Types

```typescript
// Peer identifier
type PeerID = `${number}`

// Container identifier
type ContainerID = 
  | `cid:root-${string}:${ContainerType}`
  | `cid:${number}@${PeerID}:${ContainerType}`

// Tree node identifier
type TreeID = `${number}@${PeerID}`

// Operation identifier
type OpId = { 
  peer: PeerID
  counter: number 
}

// Container types
type ContainerType = "Text" | "Map" | "List" | "Tree" | "MovableList" | "Counter"

// Value types
type Value =
  | ContainerID
  | string
  | number
  | boolean
  | null
  | { [key: string]: Value }
  | Uint8Array
  | Value[]
  | undefined
```

### Version Types
Loro uses two complementary version representations: Version Vectors (per-peer counters) and Frontiers (a compact set of heads). See [Version Vector](/docs/concepts/version_vector) and [Frontiers](/docs/concepts/frontiers). For the full DAG model, see [Version Deep Dive](/docs/advanced/version_deep_dive).

```typescript
// Version vector class
class VersionVector {
  constructor(value: Map<PeerID, number> | Uint8Array | VersionVector | undefined | null)
  static parseJSON(version: Map<PeerID, number>): VersionVector
  toJSON(): Map<PeerID, number>
  encode(): Uint8Array
  static decode(bytes: Uint8Array): VersionVector
  get(peer_id: number | bigint | `${number}`): number | undefined
  compare(other: VersionVector): number | undefined
  setEnd(id: { peer: PeerID, counter: number }): void
  setLast(id: { peer: PeerID, counter: number }): void
  remove(peer: PeerID): void
  length(): number
}

// Frontiers represent a specific version
type Frontiers = OpId[]

// ID span for range queries
type IdSpan = {
  peer: PeerID
  counter: number
  length: number
}
```

### Change Types

```typescript
// Change metadata
interface Change {
  peer: PeerID
  counter: number
  lamport: number
  length: number
  timestamp: number  // Unix timestamp in seconds
  deps: OpId[]
  message: string | undefined
}

// Change modifier for pre-commit hooks
interface ChangeModifier {
  setMessage(message: string): this
  setTimestamp(timestamp: number): this
}
```

### Cursor Types
Stable cursors survive concurrent edits and resolve to absolute positions on demand. See [Cursor and Stable Positions](/docs/concepts/cursor_stable_positions) and [Cursor tutorial](/docs/tutorial/cursor).

```typescript
// Stable position in containers
class Cursor {
  containerId(): ContainerID
  pos(): OpId | undefined
  side(): Side  // -1 | 0 | 1
  encode(): Uint8Array
  static decode(data: Uint8Array): Cursor
}

// Cursor side affinity
type Side = -1 | 0 | 1
```

### Delta Type
Delta is a popular rich-text operation format (e.g., Quill). LoroText can export/import Delta; see [Text](/docs/tutorial/text).

```typescript
// Rich text delta operations
type Delta<T> =
  | {
      insert: T
      attributes?: { [key in string]: {} }
      retain?: undefined
      delete?: undefined
    }
  | {
      delete: number
      attributes?: undefined
      retain?: undefined
      insert?: undefined
    }
  | {
      retain: number
      attributes?: { [key in string]: {} }
      delete?: undefined
      insert?: undefined
    }
```

---

## Utility Functions

### Type Checking

```ts twoslash
import { LoroDoc, isContainer, isContainerId, getType } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
// Check if value is a container
const map = doc.getMap("map");
console.log(isContainer(map));        // true
console.log(isContainer("string"));   // false

// Check if string is a container ID
console.log(isContainerId("cid:root-map:Map"));  // true
console.log(isContainerId("regular-string"));     // false

// Get type of value
console.log(getType(map));           // "Map"
console.log(getType("string"));      // "Json"
console.log(getType(doc.getText("text")));  // "Text"
```

### ID Creation

```ts twoslash
import { newContainerID, newRootContainerID } from "loro-crdt";
// ---cut---
// Create container ID from operation ID
const opId = { peer: "1" as const, counter: 100 };
const containerId = newContainerID(opId, "List");
// "cid:100@1:List"

// Create root container ID
const rootId = newRootContainerID("myMap", "Map");
// "cid:root-myMap:Map"
```

### ID Parsing

```ts twoslash
import { idStrToId } from "loro-crdt";
// ---cut---
const op = idStrToId("0@1"); // { peer: "1", counter: 0 }
```

### Frontier Encoding

```ts twoslash
import { LoroDoc, encodeFrontiers, decodeFrontiers } from "loro-crdt";
const doc = new LoroDoc();
// ---cut---
// Encode frontiers for transmission
const frontiers = doc.frontiers();
const encoded = encodeFrontiers(frontiers);

// Decode frontiers
const decoded = decodeFrontiers(encoded);
```

---

## EphemeralStore

Manages ephemeral state like cursor positions and user presence. See [Ephemeral Store](/docs/tutorial/ephemeral) for concepts and usage patterns:

```ts no_run twoslash
import { EphemeralStore } from "loro-crdt";
declare const websocket: {
  send: (data: Uint8Array) => void;
  on: (event: string, handler: (data: any) => void) => void;
};
// ---cut---
// Create ephemeral store with 30 second timeout
const store = new EphemeralStore(30000);

// Set ephemeral values
store.set("cursor", { line: 10, column: 5 });
store.set("selection", { start: 0, end: 10 });
store.set("user", { name: "Alice", color: "#ff0000" });

// Get values
const cursor = store.get("cursor");

// Subscribe to changes
store.subscribe((event) => {
  console.log("Ephemeral state changed:", event);
});

// Subscribe to local updates for syncing
store.subscribeLocalUpdates((data) => {
  // Send to remote peers
  websocket.send(data);
});

// Apply remote updates
websocket.on('message', (data) => {
  store.apply(new Uint8Array(data));
});

// Clean up
store.destroy();
```

---

## Awareness (deprecated)

The `Awareness` class is deprecated in favor of `EphemeralStore`. Prefer using `EphemeralStore` for presence and cursor synchronization.

```ts no_run twoslash
import { Awareness } from "loro-crdt";
// ---cut---
const awareness = new Awareness("1", 30000);
// Use EphemeralStore instead for new code
```

</div>
