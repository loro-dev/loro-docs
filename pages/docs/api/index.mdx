import { ApiReferenceWrapper } from './api-reference-wrapper'

<ApiReferenceWrapper>

# API Reference

## Overview

Loro is a powerful Conflict-free Replicated Data Type (CRDT) library that enables real-time collaboration. This API reference provides comprehensive documentation for all classes, methods, and types available in the JavaScript/TypeScript binding.

## Quick Navigation

- [**LoroDoc**](#lorodoc) - The main document class for managing CRDT state
- [**Container Types**](#container-types) - Data structures (Text, List, Map, Tree, Counter, MovableList)
- [**Synchronization**](#synchronization) - Import/export and real-time sync
- [**Version Control**](#version-control) - Time travel, checkouts, and forks
- [**Events & Subscriptions**](#events--subscriptions) - Change tracking and reactivity
- [**Undo/Redo**](#undoredo) - Local undo management
- [**Types & Interfaces**](#types--interfaces) - TypeScript type definitions

## Basic Usage

```typescript twoslash
import { LoroDoc } from "loro-crdt";

const doc = new LoroDoc();
const text = doc.getText("text");
text.insert(0, "Hello World");

// Subscribe to changes
const unsubscribe = doc.subscribe((event) => {
  console.log("Document changed:", event);
});

// Export updates for synchronization
const updates = doc.export({ mode: "update" });
```

---

## LoroDoc

The `LoroDoc` class is the central document that manages all CRDT containers and provides synchronization capabilities.

### Constructor

```typescript
new LoroDoc()
```

Creates a new Loro document with a randomly generated peer ID.

**Example:**
```typescript
const doc = new LoroDoc();
```

### Configuration Methods

#### setPeerId

```typescript
setPeerId(peer: PeerID): void
```

Sets the peer ID for this document. The peer ID must be a number between 0 and 2^53-1.

**Parameters:**
- `peer` - A numeric peer ID as a string (e.g., "0", "1", "100")

**Example:**
```typescript
doc.setPeerId("42");
```

#### setRecordTimestamp

```typescript
setRecordTimestamp(auto_record: boolean): void
```

Configures whether to automatically record timestamps for changes. Timestamps use Unix time (seconds since epoch).

**Parameters:**
- `auto_record` - Whether to automatically record timestamps

**Example:**
```typescript
doc.setRecordTimestamp(true);
```

#### setChangeMergeInterval

```typescript
setChangeMergeInterval(interval: number): void
```

Sets the interval in milliseconds for merging continuous changes into a single change record. This helps reduce the number of change events.

**Parameters:**
- `interval` - Merge interval in milliseconds

**Example:**
```typescript
doc.setChangeMergeInterval(1000); // Merge changes within 1 second
```

#### configTextStyle

```typescript
configTextStyle(styles: StyleConfig): void
```

Configures the behavior of text styles (marks) in rich text containers.

**Parameters:**
- `styles` - Configuration object mapping style names to their config

**StyleConfig Type:**
```typescript
type StyleConfig = Record<string, {
  expand?: "after" | "before" | "both" | "none"
}>
```

**Example:**
```typescript
doc.configTextStyle({
  bold: { expand: "after" },
  italic: { expand: "none" },
  link: { expand: "none" }
});
```

### Container Access Methods

#### getText

```typescript
getText(name: string): LoroText
```

Gets or creates a text container with the given name.

**Parameters:**
- `name` - The container name

**Returns:** A `LoroText` instance

**Example:**
```typescript
const text = doc.getText("content");
text.insert(0, "Hello");
```

#### getList

```typescript
getList(name: string): LoroList
```

Gets or creates a list container with the given name.

**Parameters:**
- `name` - The container name  

**Returns:** A `LoroList` instance

**Example:**
```typescript
const list = doc.getList("items");
list.push("Item 1");
```

#### getMap

```typescript
getMap(name: string): LoroMap
```

Gets or creates a map container with the given name.

**Parameters:**
- `name` - The container name

**Returns:** A `LoroMap` instance

**Example:**
```typescript
const map = doc.getMap("settings");
map.set("theme", "dark");
```

#### getTree

```typescript
getTree(name: string): LoroTree
```

Gets or creates a tree container with the given name.

**Parameters:**
- `name` - The container name

**Returns:** A `LoroTree` instance

**Example:**
```typescript
const tree = doc.getTree("fileSystem");
const root = tree.createNode();
```

#### getCounter

```typescript
getCounter(name: string): LoroCounter
```

Gets or creates a counter container with the given name.

**Parameters:**
- `name` - The container name

**Returns:** A `LoroCounter` instance

**Example:**
```typescript
const counter = doc.getCounter("likes");
counter.increment(1);
```

#### getMovableList

```typescript
getMovableList(name: string): LoroMovableList
```

Gets or creates a movable list container with the given name.

**Parameters:**
- `name` - The container name

**Returns:** A `LoroMovableList` instance

**Example:**
```typescript
const movableList = doc.getMovableList("tasks");
movableList.push("Task 1");
movableList.move(0, 2); // Move first item to third position
```

#### getContainerById

```typescript
getContainerById(id: ContainerID): Container | undefined
```

Gets a container by its unique ID.

**Parameters:**
- `id` - The container ID

**Returns:** The container instance or undefined if not found

**Example:**
```typescript
const text = doc.getText("text");
const textId = text.id;
const sameText = doc.getContainerById(textId);
```

### Import/Export Methods

#### export

```typescript
export(mode?: ExportMode): Uint8Array
```

Exports the document in various formats for synchronization or persistence.

**Parameters:**
- `mode` - Export configuration (optional)

**ExportMode Options:**
```typescript
type ExportMode = 
  | { mode: "snapshot" }              // Full document state
  | { mode: "update", from?: VersionVector }  // Updates from version
  | { mode: "shallow-snapshot", frontiers: Frontiers }  // GC'd snapshot
  | { mode: "updates-in-range", spans: IdSpan[] }  // Specific ID ranges
```

**Returns:** Encoded binary data

**Examples:**
```typescript
// Export full snapshot
const snapshot = doc.export({ mode: "snapshot" });

// Export updates from a specific version
const updates = doc.export({ 
  mode: "update", 
  from: lastSyncVersion 
});

// Export shallow snapshot at current version
const shallowSnapshot = doc.export({ 
  mode: "shallow-snapshot",
  frontiers: doc.frontiers()
});
```

#### import

```typescript
import(data: Uint8Array | LoroDoc): void
```

Imports updates or snapshots into the document.

**Parameters:**
- `data` - Binary data or another LoroDoc to import from

**Example:**
```typescript
// Import binary updates
doc.import(updates);

// Import from another document
const otherDoc = new LoroDoc();
doc.import(otherDoc);
```

#### importBatch

```typescript
importBatch(data: Uint8Array[]): void
```

Efficiently imports multiple updates in a single batch operation.

**Parameters:**
- `data` - Array of binary updates

**Example:**
```typescript
const updates = [update1, update2, update3];
doc.importBatch(updates);
```

#### exportJsonUpdates

```typescript
exportJsonUpdates(start?: VersionVector, end?: VersionVector): JsonSchema
```

Exports updates in JSON format for debugging or alternative storage.

**Parameters:**
- `start` - Starting version (optional)
- `end` - Ending version (optional)

**Returns:** JSON representation of updates

**Example:**
```typescript
const jsonUpdates = doc.exportJsonUpdates();
console.log(JSON.stringify(jsonUpdates, null, 2));
```

#### importJsonUpdates

```typescript
importJsonUpdates(json: string | JsonSchema): void
```

Imports updates from JSON format.

**Parameters:**
- `json` - JSON string or object containing updates

**Example:**
```typescript
const jsonStr = '{"ops": [...], "peer": "1"}';
doc.importJsonUpdates(jsonStr);
```

### Version Control Methods

#### checkout

```typescript
checkout(frontiers: Frontiers): void
```

Checks out the document to a specific version, making it read-only at that point in history.

**Parameters:**
- `frontiers` - Array of OpIds representing the target version

**Example:**
```typescript
const frontiers = doc.frontiers();
// Make some changes...
doc.checkout(frontiers); // Go back to previous version
```

#### checkoutToLatest

```typescript
checkoutToLatest(): void
```

Returns the document to the latest version after a checkout.

**Example:**
```typescript
doc.checkoutToLatest();
```

#### attach

```typescript
attach(): void
```

Attaches the document to track latest changes after being detached.

**Example:**
```typescript
doc.attach();
```

#### detach

```typescript
detach(): void
```

Detaches the document from tracking latest changes, freezing it at current version.

**Example:**
```typescript
doc.detach();
```

#### fork

```typescript
fork(): LoroDoc
```

Creates a new document that is a fork of the current one with a new peer ID.

**Returns:** A new LoroDoc instance

**Example:**
```typescript
const forkedDoc = doc.fork();
```

#### forkAt

```typescript
forkAt(frontiers: Frontiers): LoroDoc
```

Creates a fork at a specific version in history.

**Parameters:**
- `frontiers` - The version to fork from

**Returns:** A new LoroDoc instance

**Example:**
```typescript
const frontiers = doc.frontiers();
const forkedDoc = doc.forkAt(frontiers);
```

### Subscription Methods

#### subscribe

```typescript
subscribe(listener: (event: LoroEventBatch) => void): () => void
```

Subscribes to all document changes.

**Parameters:**
- `listener` - Callback function that receives change events

**Returns:** Unsubscribe function

**Event Structure:**
```typescript
interface LoroEventBatch {
  by: "local" | "import" | "checkout"
  origin?: string
  currentTarget?: ContainerID
  events: LoroEvent[]
  from: Frontiers
  to: Frontiers
}
```

**Example:**
```typescript
const unsubscribe = doc.subscribe((event) => {
  console.log("Change type:", event.by);
  event.events.forEach(e => {
    console.log("Container changed:", e.target);
    console.log("Diff:", e.diff);
  });
});

// Later: unsubscribe();
```

#### subscribeLocalUpdates

```typescript
subscribeLocalUpdates(f: (bytes: Uint8Array) => void): () => void
```

Subscribes only to local changes, useful for syncing with remote peers.

**Parameters:**
- `f` - Callback that receives binary updates

**Returns:** Unsubscribe function

**Example:**
```typescript
const unsubscribe = doc.subscribeLocalUpdates((updates) => {
  // Send updates to remote peers
  websocket.send(updates);
});
```

#### subscribeFirstCommitFromPeer

```typescript
subscribeFirstCommitFromPeer(f: (e: { peer: PeerID }) => void): () => void
```

Subscribes to the first commit from each peer, useful for tracking peer metadata.

**Parameters:**
- `f` - Callback that receives peer information

**Returns:** Unsubscribe function

**Example:**
```typescript
doc.subscribeFirstCommitFromPeer(({ peer }) => {
  // Store peer metadata
  doc.getMap("peers").set(peer, {
    joinedAt: Date.now(),
    name: `User ${peer}`
  });
});
```

### Transaction Methods

#### commit

```typescript
commit(options?: { origin?: string, message?: string, timestamp?: number }): void
```

Commits pending changes as a single transaction.

**Parameters:**
- `options` - Optional commit configuration
  - `origin` - Origin identifier for the commit
  - `message` - Commit message
  - `timestamp` - Unix timestamp in seconds

**Example:**
```typescript
doc.commit({
  origin: "user-action",
  message: "Updated document title",
  timestamp: Math.floor(Date.now() / 1000)
});
```

#### isInTransaction

```typescript
isInTransaction(): boolean
```

Checks if the document is currently in a transaction.

**Returns:** Boolean indicating transaction state

**Example:**
```typescript
if (doc.isInTransaction()) {
  console.log("Changes are pending commit");
}
```

### Query Methods

#### toJSON

```typescript
toJSON(): Value
```

Converts the entire document to a JSON-compatible value.

**Returns:** JSON representation of the document

**Example:**
```typescript
const json = doc.toJSON();
console.log(JSON.stringify(json, null, 2));
```

#### getShallowValue

```typescript
getShallowValue(): Value
```

Gets a shallow representation where sub-containers are represented by their IDs.

**Returns:** Shallow JSON value

**Example:**
```typescript
const shallow = doc.getShallowValue();
// Sub-containers appear as: "loro:cid:..."
```

#### version

```typescript
version(): VersionVector
```

Gets the current version vector of the document.

**Returns:** Map from PeerID to counter

**Example:**
```typescript
const vv = doc.version();
vv.forEach((counter, peer) => {
  console.log(`Peer ${peer}: ${counter} ops`);
});
```

#### frontiers

```typescript
frontiers(): Frontiers
```

Gets the current frontiers (heads) of the document.

**Returns:** Array of OpIds

**Example:**
```typescript
const frontiers = doc.frontiers();
// Can be used for checkouts or shallow snapshots
```

#### diff

```typescript
diff(from: Frontiers, to: Frontiers, for_json?: boolean): [ContainerID, Diff | JsonDiff][]
```

Calculates differences between two versions.

**Parameters:**
- `from` - Starting frontiers
- `to` - Ending frontiers  
- `for_json` - If true, returns JsonDiff format (default: true)

**Returns:** Array of container IDs and their diffs

**Example:**
```typescript
const fromFrontiers = doc.frontiers();
// Make changes...
const toFrontiers = doc.frontiers();

const diffs = doc.diff(fromFrontiers, toFrontiers);
diffs.forEach(([containerId, diff]) => {
  console.log(`Container ${containerId} changed:`, diff);
});
```

---

## Container Types

### LoroText

A rich text container supporting collaborative text editing with formatting.

#### Methods

##### insert

```typescript
insert(index: number, text: string): void
```

Inserts text at the specified position.

**Parameters:**
- `index` - Position to insert at (0-based)
- `text` - Text to insert

**Example:**
```typescript
text.insert(0, "Hello ");
text.insert(6, "World");
```

##### delete

```typescript
delete(index: number, len: number): void
```

Deletes text from the specified position.

**Parameters:**
- `index` - Starting position
- `len` - Number of characters to delete

**Example:**
```typescript
text.delete(5, 1); // Delete one character at position 5
```

##### mark

```typescript
mark(range: { start: number, end: number }, key: string, value: Value): void
```

Applies formatting to a text range.

**Parameters:**
- `range` - The range to format
- `key` - Style attribute name
- `value` - Style value

**Example:**
```typescript
text.mark({ start: 0, end: 5 }, "bold", true);
text.mark({ start: 6, end: 11 }, "color", "#ff0000");
```

##### unmark

```typescript
unmark(range: { start: number, end: number }, key: string): void
```

Removes formatting from a text range.

**Parameters:**
- `range` - The range to unformat
- `key` - Style attribute to remove

**Example:**
```typescript
text.unmark({ start: 0, end: 5 }, "bold");
```

##### toDelta

```typescript
toDelta(): Delta<string>[]
```

Converts text to Delta format (Quill-compatible).

**Returns:** Array of Delta operations

**Example:**
```typescript
const delta = text.toDelta();
// [{ insert: "Hello", attributes: { bold: true } }, { insert: " World" }]
```

##### applyDelta

```typescript
applyDelta(delta: Delta<string>[]): void
```

Applies Delta operations to the text.

**Parameters:**
- `delta` - Array of Delta operations

**Example:**
```typescript
text.applyDelta([
  { insert: "Hello", attributes: { bold: true } },
  { insert: " World" }
]);
```

##### update

```typescript
update(text: string, options?: { retain?: boolean }): void
```

Updates text content efficiently using diff algorithm.

**Parameters:**
- `text` - New text content
- `options` - Update options
  - `retain` - Whether to retain formatting (default: true)

**Example:**
```typescript
text.update("New content", { retain: false });
```

##### getCursor

```typescript
getCursor(pos: number, side?: Side): Cursor | undefined
```

Gets a stable cursor position that survives edits.

**Parameters:**
- `pos` - Position in the text
- `side` - Cursor affinity (-1, 0, or 1)

**Returns:** Cursor object or undefined

**Example:**
```typescript
const cursor = text.getCursor(5);
// Cursor remains valid even after edits
```

##### toString

```typescript
toString(): string
```

Converts to plain text string.

**Returns:** Plain text content

**Example:**
```typescript
const plainText = text.toString();
```

### LoroList

An ordered list container for collaborative arrays.

#### Methods

##### insert

```typescript
insert(pos: number, value: Value | Container): void
```

Inserts a value at the specified position.

**Parameters:**
- `pos` - Insert position
- `value` - Value to insert

**Example:**
```typescript
list.insert(0, "First");
list.insert(1, { type: "object" });
```

##### insertContainer

```typescript
insertContainer<T extends Container>(pos: number, container: T): T
```

Inserts a new container at the position.

**Parameters:**
- `pos` - Insert position  
- `container` - Container instance

**Returns:** The inserted container

**Example:**
```typescript
const subText = list.insertContainer(0, new LoroText());
subText.insert(0, "Nested text");
```

##### delete

```typescript
delete(pos: number, len: number): void
```

Deletes elements from the list.

**Parameters:**
- `pos` - Starting position
- `len` - Number of elements to delete

**Example:**
```typescript
list.delete(1, 2); // Delete 2 elements starting at index 1
```

##### push

```typescript
push(value: Value | Container): void
```

Appends a value to the end of the list.

**Parameters:**
- `value` - Value to append

**Example:**
```typescript
list.push("Last item");
```

##### pushContainer

```typescript
pushContainer<T extends Container>(container: T): T
```

Appends a container to the end of the list.

**Parameters:**
- `container` - Container to append

**Returns:** The appended container

**Example:**
```typescript
const map = list.pushContainer(new LoroMap());
map.set("key", "value");
```

##### pop

```typescript
pop(): Value | Container | undefined
```

Removes and returns the last element.

**Returns:** The removed element or undefined

**Example:**
```typescript
const lastItem = list.pop();
```

##### get

```typescript
get(index: number): Value | Container | undefined
```

Gets the value at the specified index.

**Parameters:**
- `index` - Element index

**Returns:** The value or undefined

**Example:**
```typescript
const item = list.get(0);
```

##### getCursor

```typescript
getCursor(pos: number, side?: Side): Cursor | undefined
```

Gets a stable cursor for the position.

**Parameters:**
- `pos` - Position in the list
- `side` - Cursor affinity

**Returns:** Cursor object or undefined

**Example:**
```typescript
const cursor = list.getCursor(2);
```

##### toArray

```typescript
toArray(): (Value | Container)[]
```

Converts the list to a JavaScript array.

**Returns:** Array of values

**Example:**
```typescript
const array = list.toArray();
```

##### clear

```typescript
clear(): void
```

Removes all elements from the list.

**Example:**
```typescript
list.clear();
```

##### length

```typescript
get length(): number
```

Gets the number of elements in the list.

**Returns:** List length

**Example:**
```typescript
console.log(`List has ${list.length} items`);
```

### LoroMap

A key-value map container for collaborative objects.

#### Methods

##### set

```typescript
set(key: string, value: Value | Container): void
```

Sets a key-value pair.

**Parameters:**
- `key` - The key
- `value` - The value

**Example:**
```typescript
map.set("name", "Alice");
map.set("age", 30);
```

##### setContainer

```typescript
setContainer<T extends Container>(key: string, container: T): T
```

Sets a container as the value for a key.

**Parameters:**
- `key` - The key
- `container` - Container instance

**Returns:** The set container

**Example:**
```typescript
const list = map.setContainer("items", new LoroList());
list.push("item1");
```

##### get

```typescript
get(key: string): Value | Container | undefined
```

Gets the value for a key.

**Parameters:**
- `key` - The key

**Returns:** The value or undefined

**Example:**
```typescript
const name = map.get("name");
```

##### getOrCreateContainer

```typescript
getOrCreateContainer<T extends Container>(key: string, container: T): T
```

Gets an existing container or creates a new one.

**Parameters:**
- `key` - The key
- `container` - Container to create if not exists

**Returns:** The container

**Example:**
```typescript
const text = map.getOrCreateContainer("description", new LoroText());
```

##### delete

```typescript
delete(key: string): void
```

Removes a key-value pair.

**Parameters:**
- `key` - The key to remove

**Example:**
```typescript
map.delete("obsoleteKey");
```

##### clear

```typescript
clear(): void
```

Removes all key-value pairs.

**Example:**
```typescript
map.clear();
```

##### has

```typescript
has(key: string): boolean
```

Checks if a key exists.

**Parameters:**
- `key` - The key to check

**Returns:** Boolean indicating existence

**Example:**
```typescript
if (map.has("name")) {
  console.log("Name exists");
}
```

##### keys

```typescript
keys(): string[]
```

Gets all keys in the map.

**Returns:** Array of keys

**Example:**
```typescript
const allKeys = map.keys();
```

##### values

```typescript
values(): (Value | Container)[]
```

Gets all values in the map.

**Returns:** Array of values

**Example:**
```typescript
const allValues = map.values();
```

##### entries

```typescript
entries(): [string, Value | Container][]
```

Gets all key-value pairs.

**Returns:** Array of entries

**Example:**
```typescript
for (const [key, value] of map.entries()) {
  console.log(`${key}: ${value}`);
}
```

##### size

```typescript
get size(): number
```

Gets the number of key-value pairs.

**Returns:** Map size

**Example:**
```typescript
console.log(`Map has ${map.size} entries`);
```

### LoroTree

A hierarchical tree container for nested structures.

#### Methods

##### createNode

```typescript
createNode(parent?: TreeID, index?: number): TreeID
```

Creates a new tree node.

**Parameters:**
- `parent` - Parent node ID (optional, creates root if omitted)
- `index` - Position among siblings (optional)

**Returns:** The new node's ID

**Example:**
```typescript
const root = tree.createNode();
const child = tree.createNode(root, 0);
```

##### move

```typescript
move(target: TreeID, parent?: TreeID, index?: number): void
```

Moves a node to a new position.

**Parameters:**
- `target` - Node to move
- `parent` - New parent (undefined for root)
- `index` - Position among siblings

**Example:**
```typescript
tree.move(nodeId, newParentId, 0);
```

##### delete

```typescript
delete(target: TreeID): void
```

Deletes a node and its descendants.

**Parameters:**
- `target` - Node to delete

**Example:**
```typescript
tree.delete(nodeId);
```

##### getNodeByID

```typescript
getNodeByID(id: TreeID): LoroTreeNode | undefined
```

Gets a node handler by its ID.

**Parameters:**
- `id` - Node ID

**Returns:** Node handler or undefined

**Example:**
```typescript
const node = tree.getNodeByID(nodeId);
if (node) {
  node.data.set("label", "New Label");
}
```

##### nodes

```typescript
nodes(): LoroTreeNode[]
```

Gets all nodes in the tree.

**Returns:** Array of all nodes

**Example:**
```typescript
const allNodes = tree.nodes();
```

##### roots

```typescript
roots(): LoroTreeNode[]
```

Gets all root nodes.

**Returns:** Array of root nodes

**Example:**
```typescript
const rootNodes = tree.roots();
```

##### has

```typescript
has(target: TreeID): boolean
```

Checks if a node exists.

**Parameters:**
- `target` - Node ID to check

**Returns:** Boolean indicating existence

**Example:**
```typescript
if (tree.has(nodeId)) {
  console.log("Node exists");
}
```

##### isNodeDeleted

```typescript
isNodeDeleted(target: TreeID): boolean
```

Checks if a node has been deleted.

**Parameters:**
- `target` - Node ID to check

**Returns:** Boolean indicating deletion status

**Example:**
```typescript
if (tree.isNodeDeleted(nodeId)) {
  console.log("Node was deleted");
}
```

#### LoroTreeNode

Represents a single node in the tree.

##### Properties

###### data

```typescript
data: LoroMap
```

A map container for storing node metadata.

**Example:**
```typescript
node.data.set("title", "Node Title");
node.data.set("expanded", true);
```

##### Methods

###### createNode

```typescript
createNode(index?: number): TreeID
```

Creates a child node.

**Parameters:**
- `index` - Position among siblings

**Returns:** New node's ID

**Example:**
```typescript
const childId = node.createNode(0);
```

###### move

```typescript
move(parent?: LoroTreeNode, index?: number): void
```

Moves this node to a new parent.

**Parameters:**
- `parent` - New parent node
- `index` - Position among siblings

**Example:**
```typescript
node.move(newParentNode, 0);
```

###### moveAfter

```typescript
moveAfter(target: LoroTreeNode): void
```

Moves this node after a sibling.

**Parameters:**
- `target` - Sibling node

**Example:**
```typescript
node.moveAfter(siblingNode);
```

###### moveBefore

```typescript
moveBefore(target: LoroTreeNode): void
```

Moves this node before a sibling.

**Parameters:**
- `target` - Sibling node

**Example:**
```typescript
node.moveBefore(siblingNode);
```

###### parent

```typescript
parent(): LoroTreeNode | undefined
```

Gets the parent node.

**Returns:** Parent node or undefined

**Example:**
```typescript
const parentNode = node.parent();
```

###### children

```typescript
children(): LoroTreeNode[]
```

Gets all child nodes.

**Returns:** Array of children

**Example:**
```typescript
const childNodes = node.children();
```

###### index

```typescript
index(): number | undefined
```

Gets the position among siblings.

**Returns:** Index or undefined if root

**Example:**
```typescript
const position = node.index();
```

###### isDeleted

```typescript
isDeleted(): boolean
```

Checks if this node has been deleted.

**Returns:** Boolean deletion status

**Example:**
```typescript
if (node.isDeleted()) {
  console.log("Node is deleted");
}
```

### LoroCounter

A counter CRDT for collaborative numeric values.

#### Methods

##### increment

```typescript
increment(value?: number): void
```

Increments the counter.

**Parameters:**
- `value` - Amount to increment (default: 1)

**Example:**
```typescript
counter.increment();    // +1
counter.increment(5);   // +5
```

##### decrement

```typescript
decrement(value?: number): void
```

Decrements the counter.

**Parameters:**
- `value` - Amount to decrement (default: 1)

**Example:**
```typescript
counter.decrement();    // -1
counter.decrement(3);   // -3
```

##### value

```typescript
get value(): number
```

Gets the current counter value.

**Returns:** Current numeric value

**Example:**
```typescript
console.log(`Counter value: ${counter.value}`);
```

### LoroMovableList

A list optimized for move operations.

Extends `LoroList` with additional methods for efficient element reordering.

#### Additional Methods

##### move

```typescript
move(from: number, to: number): void
```

Moves an element from one position to another.

**Parameters:**
- `from` - Source index
- `to` - Target index

**Example:**
```typescript
movableList.move(0, 3); // Move first element to fourth position
```

##### set

```typescript
set(pos: number, value: Value | Container): void
```

Replaces the value at a position.

**Parameters:**
- `pos` - Position to update
- `value` - New value

**Example:**
```typescript
movableList.set(0, "Updated value");
```

##### setContainer

```typescript
setContainer<T extends Container>(pos: number, container: T): T
```

Replaces the value with a container.

**Parameters:**
- `pos` - Position to update
- `container` - New container

**Returns:** The set container

**Example:**
```typescript
const text = movableList.setContainer(0, new LoroText());
```

---

## Synchronization

### Import/Export Patterns

#### Basic Synchronization

```typescript
// Peer A: Export updates
const doc1 = new LoroDoc();
doc1.getText("text").insert(0, "Hello");
const updates = doc1.export({ mode: "update" });

// Peer B: Import updates
const doc2 = new LoroDoc();
doc2.import(updates);
```

#### Continuous Sync

```typescript
// Set up bidirectional sync
doc1.subscribeLocalUpdates((updates) => {
  doc2.import(updates);
});

doc2.subscribeLocalUpdates((updates) => {
  doc1.import(updates);
});
```

#### Network Sync with WebSocket

```typescript
// Client side
const doc = new LoroDoc();

// Send local updates to server
doc.subscribeLocalUpdates((updates) => {
  ws.send(updates);
});

// Receive updates from server
ws.on('message', (data) => {
  doc.import(new Uint8Array(data));
});
```

### Shallow Snapshots

Shallow snapshots allow for efficient storage by garbage collecting deleted operations.

```typescript
// Create shallow snapshot
const frontiers = doc.frontiers();
const shallowSnapshot = doc.export({
  mode: "shallow-snapshot",
  frontiers: frontiers
});

// Import shallow snapshot
const newDoc = new LoroDoc();
newDoc.import(shallowSnapshot);
```

---

## Version Control

### Time Travel

Navigate through document history:

```typescript
// Save current version
const v1 = doc.frontiers();

// Make changes
doc.getText("text").insert(0, "New text");

// Save new version
const v2 = doc.frontiers();

// Travel back
doc.checkout(v1);
console.log(doc.getText("text").toString()); // Original text

// Travel forward
doc.checkout(v2);
console.log(doc.getText("text").toString()); // New text

// Return to latest
doc.checkoutToLatest();
```

### Forking

Create document branches:

```typescript
// Fork at current state
const fork1 = doc.fork();
fork1.getText("text").insert(0, "Fork 1 changes");

// Fork at specific version
const historicalVersion = doc.frontiers();
const fork2 = doc.forkAt(historicalVersion);
fork2.getText("text").insert(0, "Fork 2 changes");

// Original document remains unchanged
```

### Version Vectors

Track document versions:

```typescript
// Get version vector
const vv = doc.version();
console.log(`Document has ${vv.size} peers`);

vv.forEach((counter, peer) => {
  console.log(`Peer ${peer}: ${counter} operations`);
});

// Compare versions
const vv1 = doc1.version();
const vv2 = doc2.version();

// Check if doc1 includes all of doc2's changes
let doc1HasAllDoc2Changes = true;
vv2.forEach((counter, peer) => {
  if (!vv1.has(peer) || vv1.get(peer) < counter) {
    doc1HasAllDoc2Changes = false;
  }
});
```

---

## Events & Subscriptions

### Event Structure

```typescript
interface LoroEventBatch {
  by: "local" | "import" | "checkout"
  origin?: string
  currentTarget?: ContainerID
  events: LoroEvent[]
  from: Frontiers
  to: Frontiers
}

interface LoroEvent {
  target: ContainerID
  diff: Diff
  path: Path
}
```

### Diff Types

Different containers produce different diff types:

#### TextDiff

```typescript
type TextDiff = {
  type: "text"
  diff: Delta<string>[]
}

// Example
text.subscribe((event) => {
  if (event.diff.type === "text") {
    event.diff.diff.forEach(delta => {
      if (delta.insert) {
        console.log(`Inserted: "${delta.insert}"`);
      }
      if (delta.delete) {
        console.log(`Deleted ${delta.delete} characters`);
      }
    });
  }
});
```

#### ListDiff

```typescript
type ListDiff = {
  type: "list"
  diff: Delta<(Value | Container)[]>[]
}

// Example
list.subscribe((event) => {
  if (event.diff.type === "list") {
    event.diff.diff.forEach(delta => {
      if (delta.insert) {
        console.log(`Inserted items:`, delta.insert);
      }
    });
  }
});
```

#### MapDiff

```typescript
type MapDiff = {
  type: "map"
  updated: Record<string, Value | Container | undefined>
}

// Example
map.subscribe((event) => {
  if (event.diff.type === "map") {
    Object.entries(event.diff.updated).forEach(([key, value]) => {
      if (value === undefined) {
        console.log(`Deleted key: ${key}`);
      } else {
        console.log(`Updated key: ${key} = ${value}`);
      }
    });
  }
});
```

#### TreeDiff

```typescript
type TreeDiff = {
  type: "tree"
  diff: TreeDiffItem[]
}

type TreeDiffItem = 
  | { action: "create", id: TreeID, parent: TreeID | undefined, index: number }
  | { action: "move", id: TreeID, parent: TreeID | undefined, index: number }
  | { action: "delete", id: TreeID }

// Example
tree.subscribe((event) => {
  if (event.diff.type === "tree") {
    event.diff.diff.forEach(item => {
      switch (item.action) {
        case "create":
          console.log(`Created node ${item.id}`);
          break;
        case "move":
          console.log(`Moved node ${item.id}`);
          break;
        case "delete":
          console.log(`Deleted node ${item.id}`);
          break;
      }
    });
  }
});
```

### Deep Subscription

Subscribe to nested changes:

```typescript
// Subscribe to specific container
const text = doc.getText("text");
text.subscribe((event) => {
  console.log("Text changed:", event);
});

// Subscribe with deep observation
doc.subscribe((event) => {
  // Path shows the location of the change
  event.events.forEach(e => {
    console.log("Change path:", e.path);
    console.log("Container:", e.target);
    console.log("Diff:", e.diff);
  });
});
```

---

## Undo/Redo

### UndoManager

Provides local undo/redo functionality:

```typescript
import { UndoManager } from "loro-crdt";

// Create undo manager
const undo = new UndoManager(doc, {
  mergeInterval: 1000,        // Merge changes within 1 second
  maxUndoSteps: 100,          // Maximum undo stack size
  excludeOriginPrefixes: ["sync-"],  // Ignore changes with these origins
});

// Perform undo/redo
if (undo.canUndo()) {
  undo.undo();
}

if (undo.canRedo()) {
  undo.redo();
}
```

### Grouping Operations

Group multiple operations into a single undo step:

```typescript
undo.groupStart();
text.insert(0, "Hello");
text.mark({ start: 0, end: 5 }, "bold", true);
map.set("lastEdit", Date.now());
undo.groupEnd();

// All three operations will be undone together
undo.undo();
```

### Custom Undo Handlers

Handle cursor restoration and side effects:

```typescript
const undo = new UndoManager(doc, {
  onPush: (isUndo, counterRange, event) => {
    // Save cursor positions when adding to undo stack
    const cursors = saveCursorPositions();
    return {
      value: doc.toJSON(),
      cursors: cursors
    };
  },
  
  onPop: (isUndo, { value, cursors }, counterRange) => {
    // Restore cursor positions when undoing
    restoreCursorPositions(cursors);
  }
});
```

---

## Types & Interfaces

### Core Types

```typescript
// Peer identifier
type PeerID = `${number}`

// Container identifier
type ContainerID = 
  | `cid:root-${string}:${ContainerType}`
  | `cid:${number}@${PeerID}:${ContainerType}`

// Tree node identifier
type TreeID = `${number}@${PeerID}`

// Operation identifier
type OpId = { 
  peer: PeerID
  counter: number 
}

// Container types
type ContainerType = "Text" | "Map" | "List" | "Tree" | "MovableList" | "Counter"

// Value types
type Value =
  | ContainerID
  | string
  | number
  | boolean
  | null
  | { [key: string]: Value }
  | Uint8Array
  | Value[]
  | undefined
```

### Version Types

```typescript
// Version vector maps peer IDs to counters
class VersionVector extends Map<PeerID, number> {
  get(peer: PeerID): number | undefined
  set(peer: PeerID, counter: number): this
  forEach(callback: (counter: number, peer: PeerID) => void): void
}

// Frontiers represent a specific version
type Frontiers = OpId[]

// ID span for range queries
type IdSpan = {
  peer: PeerID
  counter: number
  length: number
}
```

### Change Types

```typescript
// Change metadata
interface Change {
  peer: PeerID
  counter: number
  lamport: number
  length: number
  timestamp: number  // Unix timestamp in seconds
  deps: OpId[]
  message: string | undefined
}

// Change modifier for pre-commit hooks
interface ChangeModifier {
  setMessage(message: string): this
  setTimestamp(timestamp: number): this
}
```

### Cursor Types

```typescript
// Stable position in containers
class Cursor {
  containerId(): ContainerID
  pos(): OpId | undefined
  side(): Side  // -1 | 0 | 1
  encode(): Uint8Array
  static decode(data: Uint8Array): Cursor
}

// Cursor side affinity
type Side = -1 | 0 | 1
```

### Delta Type

```typescript
// Rich text delta operations
type Delta<T> =
  | {
      insert: T
      attributes?: { [key in string]: {} }
      retain?: undefined
      delete?: undefined
    }
  | {
      delete: number
      attributes?: undefined
      retain?: undefined
      insert?: undefined
    }
  | {
      retain: number
      attributes?: { [key in string]: {} }
      delete?: undefined
      insert?: undefined
    }
```

---

## Utility Functions

### Type Checking

```typescript
import { isContainer, isContainerId, getType } from "loro-crdt";

// Check if value is a container
const map = doc.getMap("map");
console.log(isContainer(map));        // true
console.log(isContainer("string"));   // false

// Check if string is a container ID
console.log(isContainerId("cid:root-map:Map"));  // true
console.log(isContainerId("regular-string"));     // false

// Get type of value
console.log(getType(map));           // "Map"
console.log(getType("string"));      // "Json"
console.log(getType(doc.getText("text")));  // "Text"
```

### ID Creation

```typescript
import { newContainerID, newRootContainerID } from "loro-crdt";

// Create container ID from operation ID
const opId = { peer: "1", counter: 100 };
const containerId = newContainerID(opId, "List");
// "cid:100@1:List"

// Create root container ID
const rootId = newRootContainerID("myMap", "Map");
// "cid:root-myMap:Map"
```

### Frontier Encoding

```typescript
import { encodeFrontiers, decodeFrontiers } from "loro-crdt";

// Encode frontiers for transmission
const frontiers = doc.frontiers();
const encoded = encodeFrontiers(frontiers);

// Decode frontiers
const decoded = decodeFrontiers(encoded);
```

---

## EphemeralStore

Manages ephemeral state like cursor positions and user presence:

```typescript
import { EphemeralStore } from "loro-crdt";

// Create ephemeral store with 30 second timeout
const store = new EphemeralStore(30000);

// Set ephemeral values
store.set("cursor", { line: 10, column: 5 });
store.set("selection", { start: 0, end: 10 });
store.set("user", { name: "Alice", color: "#ff0000" });

// Get values
const cursor = store.get("cursor");

// Subscribe to changes
store.subscribe((event) => {
  console.log("Ephemeral state changed:", event);
});

// Subscribe to local updates for syncing
store.subscribeLocalUpdates((data) => {
  // Send to remote peers
  websocket.send(data);
});

// Apply remote updates
websocket.on('message', (data) => {
  store.apply(new Uint8Array(data));
});

// Clean up
store.destroy();
```

---

## Best Practices

### 1. Peer ID Management

```typescript
// Use consistent peer IDs across sessions
const userId = getUserId();
const peerId = hashCode(userId) % Number.MAX_SAFE_INTEGER;
doc.setPeerId(peerId.toString());
```

### 2. Efficient Syncing

```typescript
// Track sync state
let lastSyncVersion = new Map();

// Sync only necessary updates
function syncWithPeer(peerId, peerDoc) {
  const lastVersion = lastSyncVersion.get(peerId);
  const updates = doc.export({ 
    mode: "update", 
    from: lastVersion 
  });
  
  peerDoc.import(updates);
  lastSyncVersion.set(peerId, doc.version());
}
```

### 3. Container Organization

```typescript
// Use clear naming conventions
const doc = new LoroDoc();
const content = doc.getTree("content");
const metadata = doc.getMap("metadata");
const comments = doc.getList("comments");

// Group related data
metadata.setContainer("author", new LoroMap());
metadata.getMap("author").set("name", "Alice");
metadata.getMap("author").set("id", "user-123");
```

### 4. Transaction Batching

```typescript
// Batch multiple operations
doc.getText("text").insert(0, "Hello");
doc.getText("text").mark({ start: 0, end: 5 }, "bold", true);
doc.getMap("meta").set("lastEdit", Date.now());

// Commit once with metadata
doc.commit({
  message: "Initial document setup",
  origin: "user-action"
});
```

### 5. Memory Management

```typescript
// Use shallow snapshots for large documents
const snapshot = doc.export({
  mode: "shallow-snapshot",
  frontiers: doc.frontiers()
});

// Clean up subscriptions
const unsubscribe = doc.subscribe(handler);
// Later...
unsubscribe();

// Destroy ephemeral stores
ephemeralStore.destroy();
```

---

## Error Handling

Common error scenarios and solutions:

```typescript
try {
  // Import operations
  doc.import(unknownData);
} catch (error) {
  if (error.message.includes("Invalid binary format")) {
    console.error("Corrupted update data");
  }
}

// Validate container IDs
if (!isContainerId(id)) {
  throw new Error(`Invalid container ID: ${id}`);
}

// Check container existence
const container = doc.getContainerById(id);
if (!container) {
  console.warn(`Container ${id} not found`);
}

// Handle undo/redo limits
if (!undo.canUndo()) {
  console.log("Nothing to undo");
}
```

---

## Performance Tips

### 1. Use Batch Operations

```typescript
// Good: Batch import
doc.importBatch([update1, update2, update3]);

// Avoid: Individual imports
doc.import(update1);
doc.import(update2);
doc.import(update3);
```

### 2. Optimize Text Updates

```typescript
// Good: Use update method for large changes
text.update(newContent);

// Avoid: Character-by-character updates
for (const char of newContent) {
  text.insert(pos++, char);
}
```

### 3. Efficient Subscriptions

```typescript
// Subscribe at appropriate level
const container = doc.getList("items");

// Good: Subscribe to specific container
container.subscribe(handler);

// Avoid: Document-level subscription for container-specific changes
doc.subscribe((event) => {
  if (event.target === container.id) {
    // Handle change
  }
});
```

### 4. Shallow Snapshots

```typescript
// Use shallow snapshots for checkpoints
const checkpoint = doc.export({
  mode: "shallow-snapshot",
  frontiers: doc.frontiers()
});

// Reduces storage size by GC'ing deleted operations
```

---

## Migration Guide

### From Loro v0.x to v1.x

```typescript
// Old API (v0.x)
const doc = new Loro();
doc.configureTextStyle({ bold: true });

// New API (v1.x)
const doc = new LoroDoc();
doc.configTextStyle({ bold: { expand: "after" } });

// Container access remains the same
const text = doc.getText("text");
const map = doc.getMap("map");
```

---

## Additional Resources

- [GitHub Repository](https://github.com/loro-dev/loro)
- [Examples](https://github.com/loro-dev/loro/tree/main/examples)
- [Discord Community](https://discord.gg/tUsBSVfqzf)
- [Blog Posts](/blog)

---

## License

Loro is licensed under the MIT License. See the [LICENSE](https://github.com/loro-dev/loro/blob/main/LICENSE) file for details.

</ApiReferenceWrapper>
