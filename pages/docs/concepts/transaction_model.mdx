# Transaction Model

## Quick Reference

**Loro transactions are NOT database ACID transactions.** They are operation bundling mechanisms for event emission.

## Key Concepts

- **Purpose**: Bundle related operations and control event emission
- **No rollback**: Failed operations don't undo previous ones
- **Event batching**: Single event for all operations in transaction
- **History grouping**: Operations stay together for undo/redo

## Basic Usage

```ts twoslash
import { LoroDoc } from "loro-crdt";
// ---cut---
const doc = new LoroDoc();

// Without transaction - multiple events
const text = doc.getText("text");
text.insert(0, "Hello");
doc.commit(); // Event emitted
text.insert(5, " World");
doc.commit(); // Another event

// With transaction - single event
doc.transact(() => {
  text.insert(0, "Hello");
  text.insert(5, " World");
}); // One event for both operations
```

## How Transactions Work

### Pending Operations
Local operations are **pending** by default and won't emit events until committed:

```ts twoslash
import { LoroDoc } from "loro-crdt";
// ---cut---
const doc = new LoroDoc();
const text = doc.getText("text");

// Operation is pending, no event emitted yet
text.insert(0, "Hello");

// Explicit commit triggers event emission
doc.commit();
```

### Implicit Commits
Certain operations trigger implicit commits automatically:

```ts twoslash
import { LoroDoc } from "loro-crdt";
// ---cut---
const doc = new LoroDoc();
const text = doc.getText("text");

text.insert(0, "Hello"); // Pending operation

// These operations trigger implicit commit:
doc.import(new Uint8Array()); // Implicit commit before import
// or
doc.checkout(doc.frontiers()); // Implicit commit before checkout
// or
doc.export({ mode: "update" }); // Implicit commit before export
```

### Transaction Guarantees

- All operations share the same timestamp (if enabled)
- Operations grouped in a single Change
- One event emitted after transaction completes
- Operations committed together at transaction end
- Pending operations committed implicitly by import/checkout/export


## When to Use Transactions

### Use Transactions For:
- **Related operations** that logically belong together
- **Complex structures** that should appear atomically
- **Batch UI updates** to reduce re-renders
- **Form submissions** with multiple fields

### Use Direct Operations For:
- **Real-time collaboration** with character-by-character updates
- **Simple, independent changes**
- **When immediate event emission is needed**

## Code Example

```ts twoslash
import { LoroDoc } from "loro-crdt";
// ---cut---
const doc = new LoroDoc();

// Form submission pattern
function submitForm(data: Record<string, any>) {
  doc.transact(() => {
    const form = doc.getMap("form");
    for (const [key, value] of Object.entries(data)) {
      form.set(key, value);
    }
  });
  // Single event for entire form update
}

// Bulk import pattern  
function importItems(items: any[]) {
  doc.transact(() => {
    const list = doc.getList("items");
    for (const item of items) {
      list.push(item);
    }
  });
  // Single event for all items
}
```

## Common Misconceptions

### ❌ No Atomicity
If an operation fails, previous operations remain applied - no rollback!

### ❌ No Isolation  
Transactions only affect local events. Remote peers see all operations once synced.

### ❌ No Nested Savepoints
Nested transactions are flattened into the parent transaction.

## Best Practices

- Use transactions for logical units of work
- Don't over-transaction - use when bundling makes sense
- Consider sync strategy - smaller transactions for real-time collaboration
- Remember events are async (emitted after microtask)
- Use origin parameter to tag and filter events
- Be aware of implicit commits when using import/checkout/export
- Explicitly commit when you need immediate event emission

## Related Documentation

- [Operations and Changes](./operations_changes) - How transactions create Changes
- [Event System](../user-guide/events) - Understanding event emission
- [Undo/Redo](../user-guide/undo-redo) - Using transactions for undo boundaries